<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<style type="text/css">

body { font-family: courier; font-size: 12; }

.code  { font-size: 9; color: #444444; display: none; margin-left: 20px; }
.py_c_api  { color: red; }
.py_macro_api  { color: #FF7000; }
.pyx_c_api  { color: #FF3000; }
.pyx_macro_api  { color: #FF7000; }
.refnanny  { color: #FFA000; }

.error_goto  { color: #FFA000; }

.tag  {  }

.coerce  { color: #008000; border: 1px dotted #008000 }

.py_attr { color: #FF0000; font-weight: bold; }
.c_attr  { color: #0000FF; }

.py_call { color: #FF0000; font-weight: bold; }
.c_call  { color: #0000FF; }

.line { margin: 0em }

</style>
<script>
function toggleDiv(id) {
    theDiv = document.getElementById(id);
    if (theDiv.style.display == 'none') theDiv.style.display = 'block';
    else theDiv.style.display = 'none';
}
</script>
</head>
        <body>
<p>Generated by Cython 0.14.1 on Wed Jul 27 01:04:40 2011
<p>Raw output: <a href="CPWOPTcritical.c">CPWOPTcritical.c</a>
<pre class='line' style='background-color: #FFFF79' onclick='toggleDiv("line1")'> 1: #from __future__ import division</pre>
<pre id='line1' class='code' style='background-color: #FFFF79'>
  /* "CPWOPTcritical.pyx":1
 * #from __future__ import division             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * cimport cython
 * cimport numpy as np
 */
  __pyx_t_2 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_2));
  if (<span class='py_c_api'>PyObject_SetAttr</span>(__pyx_m, __pyx_n_s____test__, ((PyObject *)__pyx_t_2)) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 1; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line2")'> 2: cimport cython</pre>
<pre id='line2' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line3")'> 3: cimport numpy as np</pre>
<pre id='line3' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF8d' onclick='toggleDiv("line4")'> 4: import numpy as np</pre>
<pre id='line4' class='code' style='background-color: #FFFF8d'>
  /* "CPWOPTcritical.pyx":4
 * cimport cython
 * cimport numpy as np
 * import numpy as np             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * np.import_array()
 */
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_Import</span>(((PyObject *)__pyx_n_s__numpy), 0);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 4; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  if (<span class='py_c_api'>PyObject_SetAttr</span>(__pyx_m, __pyx_n_s__np, __pyx_t_1) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 4; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line5")'> 5: </pre>
<pre id='line5' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line6")'> 6: np.import_array()</pre>
<pre id='line6' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":6
 * import numpy as np
 * 
 * np.import_array()             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * import scipy.sparse as sparse
 */
  import_array();
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line7")'> 7: </pre>
<pre id='line7' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF62' onclick='toggleDiv("line8")'> 8: import scipy.sparse as sparse</pre>
<pre id='line8' class='code' style='background-color: #FFFF62'>
  /* "CPWOPTcritical.pyx":8
 * np.import_array()
 * 
 * import scipy.sparse as sparse             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * 
 */
  __pyx_t_1 = <span class='py_c_api'>PyList_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 8; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_1));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_n_s_17));
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_1, 0, ((PyObject *)__pyx_n_s_17));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_n_s_17));
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_Import</span>(((PyObject *)__pyx_n_s_16), ((PyObject *)__pyx_t_1));<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 8; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_1)); __pyx_t_1 = 0;
  if (<span class='py_c_api'>PyObject_SetAttr</span>(__pyx_m, __pyx_n_s__sparse, __pyx_t_2) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 8; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line9")'> 9: </pre>
<pre id='line9' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line10")'> 10: </pre>
<pre id='line10' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line11")'> 11: @cython.boundscheck(False)</pre>
<pre id='line11' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF1d' onclick='toggleDiv("line12")'> 12: def HadamardProdOfSparseTensor(np.ndarray[np.float_t,ndim=2] U not None,np.ndarray[np.float_t,ndim=2] V not None,np.ndarray[np.float_t,ndim=2] W not None,np.ndarray[np.int_t,ndim=1] Obs not None):</pre>
<pre id='line12' class='code' style='background-color: #FFFF1d'>
/* "CPWOPTcritical.pyx":12
 * 
 * @cython.boundscheck(False)
 * def HadamardProdOfSparseTensor(np.ndarray[np.float_t,ndim=2] U not None,np.ndarray[np.float_t,ndim=2] V not None,np.ndarray[np.float_t,ndim=2] W not None,np.ndarray[np.int_t,ndim=1] Obs not None):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     #print "HP start"
 *     cdef int size
 */

static PyObject *__pyx_pf_14CPWOPTcritical_HadamardProdOfSparseTensor(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_14CPWOPTcritical_HadamardProdOfSparseTensor = {<span class='pyx_macro_api'>__Pyx_NAMESTR</span>("HadamardProdOfSparseTensor"), (PyCFunction)__pyx_pf_14CPWOPTcritical_HadamardProdOfSparseTensor, METH_VARARGS|METH_KEYWORDS, <span class='pyx_macro_api'>__Pyx_DOCSTR</span>(0)};
static PyObject *__pyx_pf_14CPWOPTcritical_HadamardProdOfSparseTensor(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_U = 0;
  PyArrayObject *__pyx_v_V = 0;
  PyArrayObject *__pyx_v_W = 0;
  PyArrayObject *__pyx_v_Obs = 0;
  int __pyx_v_size;
  int __pyx_v_n;
  int __pyx_v_m;
  int __pyx_v_l;
  int __pyx_v_i;
  int __pyx_v_j;
  int __pyx_v_k;
  PyArrayObject *__pyx_v_data;
  int __pyx_v_R;
  int __pyx_v_r;
  float __pyx_v_sumval;
  Py_buffer __pyx_bstruct_U;
  Py_ssize_t __pyx_bstride_0_U = 0;
  Py_ssize_t __pyx_bstride_1_U = 0;
  Py_ssize_t __pyx_bshape_0_U = 0;
  Py_ssize_t __pyx_bshape_1_U = 0;
  Py_buffer __pyx_bstruct_W;
  Py_ssize_t __pyx_bstride_0_W = 0;
  Py_ssize_t __pyx_bstride_1_W = 0;
  Py_ssize_t __pyx_bshape_0_W = 0;
  Py_ssize_t __pyx_bshape_1_W = 0;
  Py_buffer __pyx_bstruct_V;
  Py_ssize_t __pyx_bstride_0_V = 0;
  Py_ssize_t __pyx_bstride_1_V = 0;
  Py_ssize_t __pyx_bshape_0_V = 0;
  Py_ssize_t __pyx_bshape_1_V = 0;
  Py_buffer __pyx_bstruct_data;
  Py_ssize_t __pyx_bstride_0_data = 0;
  Py_ssize_t __pyx_bshape_0_data = 0;
  Py_buffer __pyx_bstruct_Obs;
  Py_ssize_t __pyx_bstride_0_Obs = 0;
  Py_ssize_t __pyx_bshape_0_Obs = 0;
  PyObject *__pyx_r = NULL;
  static PyObject **__pyx_pyargnames[] = {&__pyx_n_s__U,&__pyx_n_s__V,&__pyx_n_s__W,&__pyx_n_s__Obs,0};
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannySetupContext</span></span>("HadamardProdOfSparseTensor");
  __pyx_self = __pyx_self;
  if (unlikely(__pyx_kwds)) {
    Py_ssize_t kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
    PyObject* values[4] = {0,0,0,0};
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
      case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
      case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
      case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      case  0: break;
      default: goto __pyx_L5_argtuple_error;
    }
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  0:
      values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__U);
      if (likely(values[0])) kw_args--;
      else goto __pyx_L5_argtuple_error;
      case  1:
      values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__V);
      if (likely(values[1])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("HadamardProdOfSparseTensor", 1, 4, 4, 1);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  2:
      values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__W);
      if (likely(values[2])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("HadamardProdOfSparseTensor", 1, 4, 4, 2);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  3:
      values[3] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__Obs);
      if (likely(values[3])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("HadamardProdOfSparseTensor", 1, 4, 4, 3);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
    }
    if (unlikely(kw_args > 0)) {
      if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args), "HadamardProdOfSparseTensor") <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    }
    __pyx_v_U = ((PyArrayObject *)values[0]);
    __pyx_v_V = ((PyArrayObject *)values[1]);
    __pyx_v_W = ((PyArrayObject *)values[2]);
    __pyx_v_Obs = ((PyArrayObject *)values[3]);
  } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 4) {
    goto __pyx_L5_argtuple_error;
  } else {
    __pyx_v_U = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0));
    __pyx_v_V = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1));
    __pyx_v_W = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2));
    __pyx_v_Obs = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3));
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("HadamardProdOfSparseTensor", 1, 4, 4, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args));<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.HadamardProdOfSparseTensor");
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_v_data = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_bstruct_data.buf = NULL;
  __pyx_bstruct_U.buf = NULL;
  __pyx_bstruct_V.buf = NULL;
  __pyx_bstruct_W.buf = NULL;
  __pyx_bstruct_Obs.buf = NULL;
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_U), __pyx_ptype_5numpy_ndarray, 0, "U", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_V), __pyx_ptype_5numpy_ndarray, 0, "V", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_W), __pyx_ptype_5numpy_ndarray, 0, "W", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_Obs), __pyx_ptype_5numpy_ndarray, 0, "Obs", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_U, (PyObject*)__pyx_v_U, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_U = __pyx_bstruct_U.strides[0]; __pyx_bstride_1_U = __pyx_bstruct_U.strides[1];
  __pyx_bshape_0_U = __pyx_bstruct_U.shape[0]; __pyx_bshape_1_U = __pyx_bstruct_U.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_V, (PyObject*)__pyx_v_V, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_V = __pyx_bstruct_V.strides[0]; __pyx_bstride_1_V = __pyx_bstruct_V.strides[1];
  __pyx_bshape_0_V = __pyx_bstruct_V.shape[0]; __pyx_bshape_1_V = __pyx_bstruct_V.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_W, (PyObject*)__pyx_v_W, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_W = __pyx_bstruct_W.strides[0]; __pyx_bstride_1_W = __pyx_bstruct_W.strides[1];
  __pyx_bshape_0_W = __pyx_bstruct_W.shape[0]; __pyx_bshape_1_W = __pyx_bstruct_W.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_Obs, (PyObject*)__pyx_v_Obs, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_Obs = __pyx_bstruct_Obs.strides[0];
  __pyx_bshape_0_Obs = __pyx_bstruct_Obs.shape[0];

  /* "CPWOPTcritical.pyx":12
 * 
 * @cython.boundscheck(False)
 * def HadamardProdOfSparseTensor(np.ndarray[np.float_t,ndim=2] U not None,np.ndarray[np.float_t,ndim=2] V not None,np.ndarray[np.float_t,ndim=2] W not None,np.ndarray[np.int_t,ndim=1] Obs not None):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     #print "HP start"
 *     cdef int size
 */
  __pyx_t_2 = PyCFunction_NewEx(&__pyx_mdef_14CPWOPTcritical_HadamardProdOfSparseTensor, NULL, __pyx_n_s__CPWOPTcritical);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  if (<span class='py_c_api'>PyObject_SetAttr</span>(__pyx_m, __pyx_n_s_3, __pyx_t_2) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 12; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line13")'> 13:     #print "HP start"</pre>
<pre id='line13' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line14")'> 14:     cdef int size</pre>
<pre id='line14' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line15")'> 15:     cdef int n,m,l</pre>
<pre id='line15' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line16")'> 16:     #cdef Coords *Obs</pre>
<pre id='line16' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line17")'> 17:     cdef int i,j,k</pre>
<pre id='line17' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line18")'> 18:     #cdef np.ndarray[np.float_t,ndim=2] U,V,W</pre>
<pre id='line18' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line19")'> 19:     cdef np.ndarray[np.float_t,ndim=1] data</pre>
<pre id='line19' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line20")'> 20: </pre>
<pre id='line20' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line21")'> 21:     cdef int R,r</pre>
<pre id='line21' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line22")'> 22:     cdef float sumval</pre>
<pre id='line22' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line23")'> 23: </pre>
<pre id='line23' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF4f' onclick='toggleDiv("line24")'> 24:     size = Obs.size / 3</pre>
<pre id='line24' class='code' style='background-color: #FFFF4f'>
  /* "CPWOPTcritical.pyx":24
 *     cdef float sumval
 * 
 *     size = Obs.size / 3             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     n=U.shape[0]
 */
  __pyx_t_1 = <span class='py_c_api'>PyObject_GetAttr</span>(((PyObject *)__pyx_v_Obs), __pyx_n_s__size);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 24; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  __pyx_t_2 = __Pyx_<span class='py_c_api'>PyNumber_Divide</span>(__pyx_t_1, __pyx_int_3);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 24; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(__pyx_t_2);<span class='error_goto'> if (unlikely((__pyx_t_3 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 24; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_size = __pyx_t_3;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line25")'> 25: </pre>
<pre id='line25' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line26")'> 26:     n=U.shape[0]</pre>
<pre id='line26' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":26
 *     size = Obs.size / 3
 * 
 *     n=U.shape[0]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     m=V.shape[0]
 *     l=W.shape[0]
 */
  __pyx_v_n = (__pyx_v_U->dimensions[0]);
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line27")'> 27:     m=V.shape[0]</pre>
<pre id='line27' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":27
 * 
 *     n=U.shape[0]
 *     m=V.shape[0]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     l=W.shape[0]
 *     R=U.shape[1]
 */
  __pyx_v_m = (__pyx_v_V->dimensions[0]);
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line28")'> 28:     l=W.shape[0]</pre>
<pre id='line28' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":28
 *     n=U.shape[0]
 *     m=V.shape[0]
 *     l=W.shape[0]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     R=U.shape[1]
 * 
 */
  __pyx_v_l = (__pyx_v_W->dimensions[0]);
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line29")'> 29:     R=U.shape[1]</pre>
<pre id='line29' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":29
 *     m=V.shape[0]
 *     l=W.shape[0]
 *     R=U.shape[1]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     #Obs must be given as list of coordinate tuples
 */
  __pyx_v_R = (__pyx_v_U->dimensions[1]);
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line30")'> 30: </pre>
<pre id='line30' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line31")'> 31:     #Obs must be given as list of coordinate tuples</pre>
<pre id='line31' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF21' onclick='toggleDiv("line32")'> 32:     data = np.zeros(size,dtype=np.float)</pre>
<pre id='line32' class='code' style='background-color: #FFFF21'>
  /* "CPWOPTcritical.pyx":32
 * 
 *     #Obs must be given as list of coordinate tuples
 *     data = np.zeros(size,dtype=np.float)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     for n in range(size):
 */
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  __pyx_t_1 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_2, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_2);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_2);
  __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_2));
  __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
  __pyx_t_6 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_5, __pyx_n_s__float);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_2, ((PyObject *)__pyx_n_s__dtype), __pyx_t_6) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
  __pyx_t_6 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_1, ((PyObject *)__pyx_t_4), ((PyObject *)__pyx_t_2));<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
  if (!(likely(((__pyx_t_6) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_6, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_6);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_data);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_data, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_3 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_8, &__pyx_t_9, &__pyx_t_10);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_data, (PyObject*)__pyx_v_data, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_8, __pyx_t_9, __pyx_t_10);
      }
    }
    __pyx_bstride_0_data = __pyx_bstruct_data.strides[0];
    __pyx_bshape_0_data = __pyx_bstruct_data.shape[0];
    if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 32; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_7 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_data));
  __pyx_v_data = ((PyArrayObject *)__pyx_t_6);
  __pyx_t_6 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line33")'> 33: </pre>
<pre id='line33' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line34")'> 34:     for n in range(size):</pre>
<pre id='line34' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":34
 *     data = np.zeros(size,dtype=np.float)
 * 
 *     for n in range(size):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         i = Obs[n*3]
 *         j = Obs[n*3+1]
 */
  __pyx_t_3 = __pyx_v_size;
  for (__pyx_t_11 = 0; __pyx_t_11 <code><</code> __pyx_t_3; __pyx_t_11+=1) {
    __pyx_v_n = __pyx_t_11;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line35")'> 35:         i = Obs[n*3]</pre>
<pre id='line35' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":35
 * 
 *     for n in range(size):
 *         i = Obs[n*3]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         j = Obs[n*3+1]
 *         k = Obs[n*3+2]
 */
    __pyx_t_12 = (__pyx_v_n * 3);
    if (__pyx_t_12 <code><</code> 0) __pyx_t_12 += __pyx_bshape_0_Obs;
    __pyx_v_i = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_Obs.buf, __pyx_t_12, __pyx_bstride_0_Obs));
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line36")'> 36:         j = Obs[n*3+1]</pre>
<pre id='line36' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":36
 *     for n in range(size):
 *         i = Obs[n*3]
 *         j = Obs[n*3+1]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         k = Obs[n*3+2]
 *         #data[n] = sum(U[i,:]*V[j,:]*W[k,:])
 */
    __pyx_t_13 = ((__pyx_v_n * 3) + 1);
    if (__pyx_t_13 <code><</code> 0) __pyx_t_13 += __pyx_bshape_0_Obs;
    __pyx_v_j = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_Obs.buf, __pyx_t_13, __pyx_bstride_0_Obs));
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line37")'> 37:         k = Obs[n*3+2]</pre>
<pre id='line37' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":37
 *         i = Obs[n*3]
 *         j = Obs[n*3+1]
 *         k = Obs[n*3+2]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         #data[n] = sum(U[i,:]*V[j,:]*W[k,:])
 *         sumval = 0.0
 */
    __pyx_t_14 = ((__pyx_v_n * 3) + 2);
    if (__pyx_t_14 <code><</code> 0) __pyx_t_14 += __pyx_bshape_0_Obs;
    __pyx_v_k = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_Obs.buf, __pyx_t_14, __pyx_bstride_0_Obs));
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line38")'> 38:         #data[n] = sum(U[i,:]*V[j,:]*W[k,:])</pre>
<pre id='line38' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line39")'> 39:         sumval = 0.0</pre>
<pre id='line39' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":39
 *         k = Obs[n*3+2]
 *         #data[n] = sum(U[i,:]*V[j,:]*W[k,:])
 *         sumval = 0.0             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         for r in range(R):
 *             sumval += U[i,r]*V[j,r]*W[k,r]
 */
    __pyx_v_sumval = 0.0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line40")'> 40:         for r in range(R):</pre>
<pre id='line40' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":40
 *         #data[n] = sum(U[i,:]*V[j,:]*W[k,:])
 *         sumval = 0.0
 *         for r in range(R):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             sumval += U[i,r]*V[j,r]*W[k,r]
 *         data[n] = sumval
 */
    __pyx_t_15 = __pyx_v_R;
    for (__pyx_t_16 = 0; __pyx_t_16 <code><</code> __pyx_t_15; __pyx_t_16+=1) {
      __pyx_v_r = __pyx_t_16;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line41")'> 41:             sumval += U[i,r]*V[j,r]*W[k,r]</pre>
<pre id='line41' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":41
 *         sumval = 0.0
 *         for r in range(R):
 *             sumval += U[i,r]*V[j,r]*W[k,r]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         data[n] = sumval
 * 
 */
      __pyx_t_17 = __pyx_v_i;
      __pyx_t_18 = __pyx_v_r;
      if (__pyx_t_17 <code><</code> 0) __pyx_t_17 += __pyx_bshape_0_U;
      if (__pyx_t_18 <code><</code> 0) __pyx_t_18 += __pyx_bshape_1_U;
      __pyx_t_19 = __pyx_v_j;
      __pyx_t_20 = __pyx_v_r;
      if (__pyx_t_19 <code><</code> 0) __pyx_t_19 += __pyx_bshape_0_V;
      if (__pyx_t_20 <code><</code> 0) __pyx_t_20 += __pyx_bshape_1_V;
      __pyx_t_21 = __pyx_v_k;
      __pyx_t_22 = __pyx_v_r;
      if (__pyx_t_21 <code><</code> 0) __pyx_t_21 += __pyx_bshape_0_W;
      if (__pyx_t_22 <code><</code> 0) __pyx_t_22 += __pyx_bshape_1_W;
      __pyx_v_sumval = (__pyx_v_sumval + (((*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float_t *, __pyx_bstruct_U.buf, __pyx_t_17, __pyx_bstride_0_U, __pyx_t_18, __pyx_bstride_1_U)) * (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float_t *, __pyx_bstruct_V.buf, __pyx_t_19, __pyx_bstride_0_V, __pyx_t_20, __pyx_bstride_1_V))) * (*__Pyx_BufPtrStrided2d(__pyx_t_5numpy_float_t *, __pyx_bstruct_W.buf, __pyx_t_21, __pyx_bstride_0_W, __pyx_t_22, __pyx_bstride_1_W))));
    }
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line42")'> 42:         data[n] = sumval</pre>
<pre id='line42' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":42
 *         for r in range(R):
 *             sumval += U[i,r]*V[j,r]*W[k,r]
 *         data[n] = sumval             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     #print "HP end"
 */
    __pyx_t_15 = __pyx_v_n;
    if (__pyx_t_15 <code><</code> 0) __pyx_t_15 += __pyx_bshape_0_data;
    *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_float_t *, __pyx_bstruct_data.buf, __pyx_t_15, __pyx_bstride_0_data) = __pyx_v_sumval;
  }
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line43")'> 43: </pre>
<pre id='line43' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line44")'> 44:     #print "HP end"</pre>
<pre id='line44' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF37' onclick='toggleDiv("line45")'> 45:     return data</pre>
<pre id='line45' class='code' style='background-color: #FFFF37'>
  /* "CPWOPTcritical.pyx":45
 * 
 *     #print "HP end"
 *     return data             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * 
 */
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_data));
  __pyx_r = ((PyObject *)__pyx_v_data);
  goto __pyx_L0;

  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&__pyx_type, &__pyx_value, &__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_U);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_W);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_V);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_data);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Obs);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.HadamardProdOfSparseTensor");
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_U);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_W);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_V);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_data);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Obs);
  __pyx_L2:;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_data);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_XGIVEREF</span></span>(__pyx_r);
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return __pyx_r;
}
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line46")'> 46: </pre>
<pre id='line46' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line47")'> 47: </pre>
<pre id='line47' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line48")'> 48: @cython.boundscheck(False)</pre>
<pre id='line48' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF19' onclick='toggleDiv("line49")'> 49: def unfold(np.ndarray[np.float_t,ndim=1] X not None, int mode, tuple shape not None,np.ndarray[np.int_t,ndim=1] ObsList not None):</pre>
<pre id='line49' class='code' style='background-color: #FFFF19'>
/* "CPWOPTcritical.pyx":49
 * 
 * @cython.boundscheck(False)
 * def unfold(np.ndarray[np.float_t,ndim=1] X not None, int mode, tuple shape not None,np.ndarray[np.int_t,ndim=1] ObsList not None):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     #X is dense vector with only observed elements
 *     #print "unfold start"
 */

static PyObject *__pyx_pf_14CPWOPTcritical_1unfold(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_14CPWOPTcritical_1unfold = {<span class='pyx_macro_api'>__Pyx_NAMESTR</span>("unfold"), (PyCFunction)__pyx_pf_14CPWOPTcritical_1unfold, METH_VARARGS|METH_KEYWORDS, <span class='pyx_macro_api'>__Pyx_DOCSTR</span>(0)};
static PyObject *__pyx_pf_14CPWOPTcritical_1unfold(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_X = 0;
  int __pyx_v_mode;
  PyObject *__pyx_v_shape = 0;
  PyArrayObject *__pyx_v_ObsList = 0;
  int __pyx_v_n;
  int __pyx_v_size;
  int __pyx_v_N;
  int __pyx_v_M;
  int __pyx_v_L;
  int __pyx_v_i;
  int __pyx_v_j;
  int __pyx_v_k;
  PyArrayObject *__pyx_v_col;
  PyArrayObject *__pyx_v_row;
  Py_buffer __pyx_bstruct_row;
  Py_ssize_t __pyx_bstride_0_row = 0;
  Py_ssize_t __pyx_bshape_0_row = 0;
  Py_buffer __pyx_bstruct_ObsList;
  Py_ssize_t __pyx_bstride_0_ObsList = 0;
  Py_ssize_t __pyx_bshape_0_ObsList = 0;
  Py_buffer __pyx_bstruct_X;
  Py_ssize_t __pyx_bstride_0_X = 0;
  Py_ssize_t __pyx_bshape_0_X = 0;
  Py_buffer __pyx_bstruct_col;
  Py_ssize_t __pyx_bstride_0_col = 0;
  Py_ssize_t __pyx_bshape_0_col = 0;
  PyObject *__pyx_r = NULL;
  static PyObject **__pyx_pyargnames[] = {&__pyx_n_s__X,&__pyx_n_s__mode,&__pyx_n_s__shape,&__pyx_n_s__ObsList,0};
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannySetupContext</span></span>("unfold");
  __pyx_self = __pyx_self;
  if (unlikely(__pyx_kwds)) {
    Py_ssize_t kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
    PyObject* values[4] = {0,0,0,0};
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
      case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
      case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
      case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      case  0: break;
      default: goto __pyx_L5_argtuple_error;
    }
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  0:
      values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__X);
      if (likely(values[0])) kw_args--;
      else goto __pyx_L5_argtuple_error;
      case  1:
      values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__mode);
      if (likely(values[1])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("unfold", 1, 4, 4, 1);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  2:
      values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__shape);
      if (likely(values[2])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("unfold", 1, 4, 4, 2);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  3:
      values[3] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__ObsList);
      if (likely(values[3])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("unfold", 1, 4, 4, 3);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
    }
    if (unlikely(kw_args > 0)) {
      if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args), "unfold") <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    }
    __pyx_v_X = ((PyArrayObject *)values[0]);
    __pyx_v_mode = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(values[1]);<span class='error_goto'> if (unlikely((__pyx_v_mode == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    __pyx_v_shape = ((PyObject*)values[2]);
    __pyx_v_ObsList = ((PyArrayObject *)values[3]);
  } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 4) {
    goto __pyx_L5_argtuple_error;
  } else {
    __pyx_v_X = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0));
    __pyx_v_mode = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1));<span class='error_goto'> if (unlikely((__pyx_v_mode == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    __pyx_v_shape = ((PyObject*)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2));
    __pyx_v_ObsList = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3));
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("unfold", 1, 4, 4, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args));<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.unfold");
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_v_col = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_row = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_bstruct_col.buf = NULL;
  __pyx_bstruct_row.buf = NULL;
  __pyx_bstruct_X.buf = NULL;
  __pyx_bstruct_ObsList.buf = NULL;
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_X), __pyx_ptype_5numpy_ndarray, 0, "X", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_shape), (&PyTuple_Type), 0, "shape", 1)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_ObsList), __pyx_ptype_5numpy_ndarray, 0, "ObsList", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_X, (PyObject*)__pyx_v_X, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_X = __pyx_bstruct_X.strides[0];
  __pyx_bshape_0_X = __pyx_bstruct_X.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_ObsList, (PyObject*)__pyx_v_ObsList, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_ObsList = __pyx_bstruct_ObsList.strides[0];
  __pyx_bshape_0_ObsList = __pyx_bstruct_ObsList.shape[0];

  /* "CPWOPTcritical.pyx":49
 * 
 * @cython.boundscheck(False)
 * def unfold(np.ndarray[np.float_t,ndim=1] X not None, int mode, tuple shape not None,np.ndarray[np.int_t,ndim=1] ObsList not None):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     #X is dense vector with only observed elements
 *     #print "unfold start"
 */
  __pyx_t_2 = PyCFunction_NewEx(&__pyx_mdef_14CPWOPTcritical_1unfold, NULL, __pyx_n_s__CPWOPTcritical);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  if (<span class='py_c_api'>PyObject_SetAttr</span>(__pyx_m, __pyx_n_s__unfold, __pyx_t_2) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 49; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line50")'> 50:     #X is dense vector with only observed elements</pre>
<pre id='line50' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line51")'> 51:     #print "unfold start"</pre>
<pre id='line51' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line52")'> 52: </pre>
<pre id='line52' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line53")'> 53:     cdef int n,m,l,size,N,M,L,i,j,k</pre>
<pre id='line53' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line54")'> 54:     cdef np.ndarray[np.int_t,ndim=1] col,row</pre>
<pre id='line54' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line55")'> 55:     #cdef np.ndarray[np.float_t,ndim=1] val</pre>
<pre id='line55' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line56")'> 56:     #cdef float val</pre>
<pre id='line56' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line57")'> 57:     #cdef sparse.lil_matrix</pre>
<pre id='line57' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line58")'> 58: </pre>
<pre id='line58' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF3b' onclick='toggleDiv("line59")'> 59:     N,M,L = shape[0],shape[1],shape[2]</pre>
<pre id='line59' class='code' style='background-color: #FFFF3b'>
  /* "CPWOPTcritical.pyx":59
 *     #cdef sparse.lil_matrix
 * 
 *     N,M,L = shape[0],shape[1],shape[2]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     size = ObsList.size / 3
 * 
 */
  __pyx_t_1 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_v_shape, 0));<span class='error_goto'> if (unlikely((__pyx_t_1 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 59; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_2 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_v_shape, 1));<span class='error_goto'> if (unlikely((__pyx_t_2 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 59; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_3 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_v_shape, 2));<span class='error_goto'> if (unlikely((__pyx_t_3 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 59; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_v_N = __pyx_t_1;
  __pyx_v_M = __pyx_t_2;
  __pyx_v_L = __pyx_t_3;
</pre><pre class='line' style='background-color: #FFFF4f' onclick='toggleDiv("line60")'> 60:     size = ObsList.size / 3</pre>
<pre id='line60' class='code' style='background-color: #FFFF4f'>
  /* "CPWOPTcritical.pyx":60
 * 
 *     N,M,L = shape[0],shape[1],shape[2]
 *     size = ObsList.size / 3             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * 
 */
  __pyx_t_4 = <span class='py_c_api'>PyObject_GetAttr</span>(((PyObject *)__pyx_v_ObsList), __pyx_n_s__size);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 60; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
  __pyx_t_5 = __Pyx_<span class='py_c_api'>PyNumber_Divide</span>(__pyx_t_4, __pyx_int_3);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 60; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  __pyx_t_3 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(__pyx_t_5);<span class='error_goto'> if (unlikely((__pyx_t_3 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 60; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
  __pyx_v_size = __pyx_t_3;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line61")'> 61: </pre>
<pre id='line61' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line62")'> 62: </pre>
<pre id='line62' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line63")'> 63:     if mode==0:</pre>
<pre id='line63' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":63
 * 
 * 
 *     if mode==0:             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)
 */
    case 0:
</pre><pre class='line' style='background-color: #FFFF25' onclick='toggleDiv("line64")'> 64:         row = np.zeros(size,dtype=int)</pre>
<pre id='line64' class='code' style='background-color: #FFFF25'>
    /* "CPWOPTcritical.pyx":64
 * 
 *     if mode==0:
 *         row = np.zeros(size,dtype=int)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):
 */
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    __pyx_t_4 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_5, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, __pyx_t_5);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_5 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_5));
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_5, ((PyObject *)__pyx_n_s__dtype), ((PyObject *)((PyObject*)(&PyInt_Type)))) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_7 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_4, ((PyObject *)__pyx_t_6), ((PyObject *)__pyx_t_5));<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_6)); __pyx_t_6 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_5)); __pyx_t_5 = 0;
    if (!(likely(((__pyx_t_7) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_7, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_7);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_row);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_row, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_3 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_9, &__pyx_t_10, &__pyx_t_11);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_row, (PyObject*)__pyx_v_row, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_11);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_9, __pyx_t_10, __pyx_t_11);
        }
      }
      __pyx_bstride_0_row = __pyx_bstruct_row.strides[0];
      __pyx_bshape_0_row = __pyx_bstruct_row.shape[0];
      if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 64; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_8 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_row));
    __pyx_v_row = ((PyArrayObject *)__pyx_t_7);
    __pyx_t_7 = 0;
</pre><pre class='line' style='background-color: #FFFF25' onclick='toggleDiv("line65")'> 65:         col = np.zeros(size,dtype=int)</pre>
<pre id='line65' class='code' style='background-color: #FFFF25'>
    /* "CPWOPTcritical.pyx":65
 *     if mode==0:
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 */
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_5 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_7, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, __pyx_t_7);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_7);
    __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_7));
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_7, ((PyObject *)__pyx_n_s__dtype), ((PyObject *)((PyObject*)(&PyInt_Type)))) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_4 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_5, ((PyObject *)__pyx_t_6), ((PyObject *)__pyx_t_7));<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_6)); __pyx_t_6 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_7)); __pyx_t_7 = 0;
    if (!(likely(((__pyx_t_4) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_4, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_4);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_col);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_col, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_3 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_11, &__pyx_t_10, &__pyx_t_9);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_col, (PyObject*)__pyx_v_col, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_9);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_11, __pyx_t_10, __pyx_t_9);
        }
      }
      __pyx_bstride_0_col = __pyx_bstruct_col.strides[0];
      __pyx_bshape_0_col = __pyx_bstruct_col.shape[0];
      if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 65; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_8 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_col));
    __pyx_v_col = ((PyArrayObject *)__pyx_t_4);
    __pyx_t_4 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line66")'> 66:         for n in range(size):</pre>
<pre id='line66' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":66
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = i
 */
    __pyx_t_3 = __pyx_v_size;
    for (__pyx_t_2 = 0; __pyx_t_2 <code><</code> __pyx_t_3; __pyx_t_2+=1) {
      __pyx_v_n = __pyx_t_2;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line67")'> 67:             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]</pre>
<pre id='line67' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":67
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             row[n] = i
 *             col[n] = j+k*M
 */
      __pyx_t_12 = (__pyx_v_n * 3);
      if (__pyx_t_12 <code><</code> 0) __pyx_t_12 += __pyx_bshape_0_ObsList;
      __pyx_t_13 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_12, __pyx_bstride_0_ObsList));
      __pyx_t_14 = ((__pyx_v_n * 3) + 1);
      if (__pyx_t_14 <code><</code> 0) __pyx_t_14 += __pyx_bshape_0_ObsList;
      __pyx_t_15 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_14, __pyx_bstride_0_ObsList));
      __pyx_t_16 = ((__pyx_v_n * 3) + 2);
      if (__pyx_t_16 <code><</code> 0) __pyx_t_16 += __pyx_bshape_0_ObsList;
      __pyx_t_17 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_16, __pyx_bstride_0_ObsList));
      __pyx_v_i = __pyx_t_13;
      __pyx_v_j = __pyx_t_15;
      __pyx_v_k = __pyx_t_17;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line68")'> 68:             row[n] = i</pre>
<pre id='line68' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":68
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = i             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             col[n] = j+k*M
 *         #print "unfold end"
 */
      __pyx_t_1 = __pyx_v_n;
      if (__pyx_t_1 <code><</code> 0) __pyx_t_1 += __pyx_bshape_0_row;
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_row.buf, __pyx_t_1, __pyx_bstride_0_row) = __pyx_v_i;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line69")'> 69:             col[n] = j+k*M</pre>
<pre id='line69' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":69
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = i
 *             col[n] = j+k*M             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(N,M*L))
 */
      __pyx_t_18 = __pyx_v_n;
      if (__pyx_t_18 <code><</code> 0) __pyx_t_18 += __pyx_bshape_0_col;
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_col.buf, __pyx_t_18, __pyx_bstride_0_col) = (__pyx_v_j + (__pyx_v_k * __pyx_v_M));
    }
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line70")'> 70:         #print "unfold end"</pre>
<pre id='line70' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF20' onclick='toggleDiv("line71")'> 71:         return sparse.csr_matrix((X,(row,col)),shape=(N,M*L))</pre>
<pre id='line71' class='code' style='background-color: #FFFF20'>
    /* "CPWOPTcritical.pyx":71
 *             col[n] = j+k*M
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(N,M*L))             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     elif mode==1:
 *         row = np.zeros(size,dtype=int)
 */
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__sparse);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
    __pyx_t_7 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_4, __pyx_n_s__csr_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_row));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, ((PyObject *)__pyx_v_row));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_row));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_col));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, ((PyObject *)__pyx_v_col));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_col));
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_X));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, ((PyObject *)__pyx_v_X));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_X));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 1, ((PyObject *)__pyx_t_4));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_t_4));
    __pyx_t_4 = 0;
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, ((PyObject *)__pyx_t_6));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_t_6));
    __pyx_t_6 = 0;
    __pyx_t_6 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    __pyx_t_5 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_N);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    __pyx_t_19 = <span class='py_c_api'>PyInt_FromLong</span>((__pyx_v_M * __pyx_v_L));<span class='error_goto'> if (unlikely(!__pyx_t_19)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_19);
    __pyx_t_20 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_20));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_20, 0, __pyx_t_5);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_5);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_20, 1, __pyx_t_19);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_19);
    __pyx_t_5 = 0;
    __pyx_t_19 = 0;
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_6, ((PyObject *)__pyx_n_s__shape), ((PyObject *)__pyx_t_20)) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_20)); __pyx_t_20 = 0;
    __pyx_t_20 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_7, ((PyObject *)__pyx_t_4), ((PyObject *)__pyx_t_6));<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 71; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_20);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_6)); __pyx_t_6 = 0;
    __pyx_r = __pyx_t_20;
    __pyx_t_20 = 0;
    goto __pyx_L0;
    break;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line72")'> 72:     elif mode==1:</pre>
<pre id='line72' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":72
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(N,M*L))
 *     elif mode==1:             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)
 */
  switch (__pyx_v_mode) {

    /* "CPWOPTcritical.pyx":72
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(N,M*L))
 *     elif mode==1:             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)
 */
    case 1:
</pre><pre class='line' style='background-color: #FFFF25' onclick='toggleDiv("line73")'> 73:         row = np.zeros(size,dtype=int)</pre>
<pre id='line73' class='code' style='background-color: #FFFF25'>
    /* "CPWOPTcritical.pyx":73
 *         return sparse.csr_matrix((X,(row,col)),shape=(N,M*L))
 *     elif mode==1:
 *         row = np.zeros(size,dtype=int)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):
 */
    __pyx_t_20 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_20);
    __pyx_t_6 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_20, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_6);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_20); __pyx_t_20 = 0;
    __pyx_t_20 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_20);
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_20);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_20);
    __pyx_t_20 = 0;
    __pyx_t_20 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_20));
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_20, ((PyObject *)__pyx_n_s__dtype), ((PyObject *)((PyObject*)(&PyInt_Type)))) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_7 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_6, ((PyObject *)__pyx_t_4), ((PyObject *)__pyx_t_20));<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_20)); __pyx_t_20 = 0;
    if (!(likely(((__pyx_t_7) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_7, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_7);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_row);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_row, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_3 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_9, &__pyx_t_10, &__pyx_t_11);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_row, (PyObject*)__pyx_v_row, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_11);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_9, __pyx_t_10, __pyx_t_11);
        }
      }
      __pyx_bstride_0_row = __pyx_bstruct_row.strides[0];
      __pyx_bshape_0_row = __pyx_bstruct_row.shape[0];
      if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 73; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_8 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_row));
    __pyx_v_row = ((PyArrayObject *)__pyx_t_7);
    __pyx_t_7 = 0;
</pre><pre class='line' style='background-color: #FFFF25' onclick='toggleDiv("line74")'> 74:         col = np.zeros(size,dtype=int)</pre>
<pre id='line74' class='code' style='background-color: #FFFF25'>
    /* "CPWOPTcritical.pyx":74
 *     elif mode==1:
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 */
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_20 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_7, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_20);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_7);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_7);
    __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_7));
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_7, ((PyObject *)__pyx_n_s__dtype), ((PyObject *)((PyObject*)(&PyInt_Type)))) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_6 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_20, ((PyObject *)__pyx_t_4), ((PyObject *)__pyx_t_7));<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_6);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_20); __pyx_t_20 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_7)); __pyx_t_7 = 0;
    if (!(likely(((__pyx_t_6) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_6, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_6);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_col);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_col, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_3 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_11, &__pyx_t_10, &__pyx_t_9);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_col, (PyObject*)__pyx_v_col, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_9);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_11, __pyx_t_10, __pyx_t_9);
        }
      }
      __pyx_bstride_0_col = __pyx_bstruct_col.strides[0];
      __pyx_bshape_0_col = __pyx_bstruct_col.shape[0];
      if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 74; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_8 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_col));
    __pyx_v_col = ((PyArrayObject *)__pyx_t_6);
    __pyx_t_6 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line75")'> 75:         for n in range(size):</pre>
<pre id='line75' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":75
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = j
 */
    __pyx_t_3 = __pyx_v_size;
    for (__pyx_t_2 = 0; __pyx_t_2 <code><</code> __pyx_t_3; __pyx_t_2+=1) {
      __pyx_v_n = __pyx_t_2;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line76")'> 76:             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]</pre>
<pre id='line76' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":76
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             row[n] = j
 *             col[n] = i+k*N
 */
      __pyx_t_21 = (__pyx_v_n * 3);
      if (__pyx_t_21 <code><</code> 0) __pyx_t_21 += __pyx_bshape_0_ObsList;
      __pyx_t_17 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_21, __pyx_bstride_0_ObsList));
      __pyx_t_22 = ((__pyx_v_n * 3) + 1);
      if (__pyx_t_22 <code><</code> 0) __pyx_t_22 += __pyx_bshape_0_ObsList;
      __pyx_t_15 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_22, __pyx_bstride_0_ObsList));
      __pyx_t_23 = ((__pyx_v_n * 3) + 2);
      if (__pyx_t_23 <code><</code> 0) __pyx_t_23 += __pyx_bshape_0_ObsList;
      __pyx_t_13 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_23, __pyx_bstride_0_ObsList));
      __pyx_v_i = __pyx_t_17;
      __pyx_v_j = __pyx_t_15;
      __pyx_v_k = __pyx_t_13;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line77")'> 77:             row[n] = j</pre>
<pre id='line77' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":77
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = j             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             col[n] = i+k*N
 *         #print "unfold end"
 */
      __pyx_t_24 = __pyx_v_n;
      if (__pyx_t_24 <code><</code> 0) __pyx_t_24 += __pyx_bshape_0_row;
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_row.buf, __pyx_t_24, __pyx_bstride_0_row) = __pyx_v_j;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line78")'> 78:             col[n] = i+k*N</pre>
<pre id='line78' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":78
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = j
 *             col[n] = i+k*N             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(M,N*L))
 */
      __pyx_t_25 = __pyx_v_n;
      if (__pyx_t_25 <code><</code> 0) __pyx_t_25 += __pyx_bshape_0_col;
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_col.buf, __pyx_t_25, __pyx_bstride_0_col) = (__pyx_v_i + (__pyx_v_k * __pyx_v_N));
    }
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line79")'> 79:         #print "unfold end"</pre>
<pre id='line79' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF20' onclick='toggleDiv("line80")'> 80:         return sparse.csr_matrix((X,(row,col)),shape=(M,N*L))</pre>
<pre id='line80' class='code' style='background-color: #FFFF20'>
    /* "CPWOPTcritical.pyx":80
 *             col[n] = i+k*N
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(M,N*L))             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     else:
 *         row = np.zeros(size,dtype=int)
 */
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
    __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__sparse);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_6);
    __pyx_t_7 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_6, __pyx_n_s__csr_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_6); __pyx_t_6 = 0;
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_row));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, ((PyObject *)__pyx_v_row));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_row));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_col));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 1, ((PyObject *)__pyx_v_col));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_col));
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_X));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, ((PyObject *)__pyx_v_X));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_X));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, ((PyObject *)__pyx_t_6));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_t_6));
    __pyx_t_6 = 0;
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, ((PyObject *)__pyx_t_4));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_t_4));
    __pyx_t_4 = 0;
    __pyx_t_4 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    __pyx_t_20 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_M);<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_20);
    __pyx_t_19 = <span class='py_c_api'>PyInt_FromLong</span>((__pyx_v_N * __pyx_v_L));<span class='error_goto'> if (unlikely(!__pyx_t_19)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_19);
    __pyx_t_5 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_5));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 0, __pyx_t_20);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_20);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_5, 1, __pyx_t_19);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_19);
    __pyx_t_20 = 0;
    __pyx_t_19 = 0;
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_4, ((PyObject *)__pyx_n_s__shape), ((PyObject *)__pyx_t_5)) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_5)); __pyx_t_5 = 0;
    __pyx_t_5 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_7, ((PyObject *)__pyx_t_6), ((PyObject *)__pyx_t_4));<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 80; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_6)); __pyx_t_6 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
    __pyx_r = __pyx_t_5;
    __pyx_t_5 = 0;
    goto __pyx_L0;
    break;
    default:
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line81")'> 81:     else:</pre>
<pre id='line81' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF25' onclick='toggleDiv("line82")'> 82:         row = np.zeros(size,dtype=int)</pre>
<pre id='line82' class='code' style='background-color: #FFFF25'>
    /* "CPWOPTcritical.pyx":82
 *         return sparse.csr_matrix((X,(row,col)),shape=(M,N*L))
 *     else:
 *         row = np.zeros(size,dtype=int)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):
 */
    __pyx_t_5 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    __pyx_t_4 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_5, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    __pyx_t_5 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, __pyx_t_5);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_5);
    __pyx_t_5 = 0;
    __pyx_t_5 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_5));
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_5, ((PyObject *)__pyx_n_s__dtype), ((PyObject *)((PyObject*)(&PyInt_Type)))) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_7 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_4, ((PyObject *)__pyx_t_6), ((PyObject *)__pyx_t_5));<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_6)); __pyx_t_6 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_5)); __pyx_t_5 = 0;
    if (!(likely(((__pyx_t_7) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_7, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_7);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_row);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_row, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_3 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_9, &__pyx_t_10, &__pyx_t_11);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_row, (PyObject*)__pyx_v_row, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_11);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_9, __pyx_t_10, __pyx_t_11);
        }
      }
      __pyx_bstride_0_row = __pyx_bstruct_row.strides[0];
      __pyx_bshape_0_row = __pyx_bstruct_row.shape[0];
      if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 82; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_8 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_row));
    __pyx_v_row = ((PyArrayObject *)__pyx_t_7);
    __pyx_t_7 = 0;
</pre><pre class='line' style='background-color: #FFFF25' onclick='toggleDiv("line83")'> 83:         col = np.zeros(size,dtype=int)</pre>
<pre id='line83' class='code' style='background-color: #FFFF25'>
    /* "CPWOPTcritical.pyx":83
 *     else:
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 */
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_5 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_7, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, __pyx_t_7);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_7);
    __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_7));
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_7, ((PyObject *)__pyx_n_s__dtype), ((PyObject *)((PyObject*)(&PyInt_Type)))) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_4 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_5, ((PyObject *)__pyx_t_6), ((PyObject *)__pyx_t_7));<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_5); __pyx_t_5 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_6)); __pyx_t_6 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_7)); __pyx_t_7 = 0;
    if (!(likely(((__pyx_t_4) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_4, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_8 = ((PyArrayObject *)__pyx_t_4);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_col);
      __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_col, (PyObject*)__pyx_t_8, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack);
      if (unlikely(__pyx_t_3 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_11, &__pyx_t_10, &__pyx_t_9);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_col, (PyObject*)__pyx_v_col, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES| PyBUF_WRITABLE, 1, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_11); Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_9);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_11, __pyx_t_10, __pyx_t_9);
        }
      }
      __pyx_bstride_0_col = __pyx_bstruct_col.strides[0];
      __pyx_bshape_0_col = __pyx_bstruct_col.shape[0];
      if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 83; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_8 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_col));
    __pyx_v_col = ((PyArrayObject *)__pyx_t_4);
    __pyx_t_4 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line84")'> 84:         for n in range(size):</pre>
<pre id='line84' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":84
 *         row = np.zeros(size,dtype=int)
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = k
 */
    __pyx_t_3 = __pyx_v_size;
    for (__pyx_t_2 = 0; __pyx_t_2 <code><</code> __pyx_t_3; __pyx_t_2+=1) {
      __pyx_v_n = __pyx_t_2;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line85")'> 85:             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]</pre>
<pre id='line85' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":85
 *         col = np.zeros(size,dtype=int)
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             row[n] = k
 *             col[n] = i+j*N
 */
      __pyx_t_26 = (__pyx_v_n * 3);
      if (__pyx_t_26 <code><</code> 0) __pyx_t_26 += __pyx_bshape_0_ObsList;
      __pyx_t_13 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_26, __pyx_bstride_0_ObsList));
      __pyx_t_27 = ((__pyx_v_n * 3) + 1);
      if (__pyx_t_27 <code><</code> 0) __pyx_t_27 += __pyx_bshape_0_ObsList;
      __pyx_t_15 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_27, __pyx_bstride_0_ObsList));
      __pyx_t_28 = ((__pyx_v_n * 3) + 2);
      if (__pyx_t_28 <code><</code> 0) __pyx_t_28 += __pyx_bshape_0_ObsList;
      __pyx_t_17 = (*__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_ObsList.buf, __pyx_t_28, __pyx_bstride_0_ObsList));
      __pyx_v_i = __pyx_t_13;
      __pyx_v_j = __pyx_t_15;
      __pyx_v_k = __pyx_t_17;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line86")'> 86:             row[n] = k</pre>
<pre id='line86' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":86
 *         for n in range(size):
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = k             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *             col[n] = i+j*N
 *         #print "unfold end"
 */
      __pyx_t_29 = __pyx_v_n;
      if (__pyx_t_29 <code><</code> 0) __pyx_t_29 += __pyx_bshape_0_row;
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_row.buf, __pyx_t_29, __pyx_bstride_0_row) = __pyx_v_k;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line87")'> 87:             col[n] = i+j*N</pre>
<pre id='line87' class='code' style='background-color: #FFFFff'>
      /* "CPWOPTcritical.pyx":87
 *             i,j,k = ObsList[n*3],ObsList[n*3+1],ObsList[n*3+2]
 *             row[n] = k
 *             col[n] = i+j*N             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(L,N*M))
 */
      __pyx_t_30 = __pyx_v_n;
      if (__pyx_t_30 <code><</code> 0) __pyx_t_30 += __pyx_bshape_0_col;
      *__Pyx_BufPtrStrided1d(__pyx_t_5numpy_int_t *, __pyx_bstruct_col.buf, __pyx_t_30, __pyx_bstride_0_col) = (__pyx_v_i + (__pyx_v_j * __pyx_v_N));
    }
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line88")'> 88:         #print "unfold end"</pre>
<pre id='line88' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF17' onclick='toggleDiv("line89")'> 89:         return sparse.csr_matrix((X,(row,col)),shape=(L,N*M))</pre>
<pre id='line89' class='code' style='background-color: #FFFF17'>
    /* "CPWOPTcritical.pyx":89
 *             col[n] = i+j*N
 *         #print "unfold end"
 *         return sparse.csr_matrix((X,(row,col)),shape=(L,N*M))             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * 
 */
    <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
    __pyx_t_4 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__sparse);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
    __pyx_t_7 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_4, __pyx_n_s__csr_matrix);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_row));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, ((PyObject *)__pyx_v_row));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_row));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_col));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 1, ((PyObject *)__pyx_v_col));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_col));
    __pyx_t_6 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_X));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 0, ((PyObject *)__pyx_v_X));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_X));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_6, 1, ((PyObject *)__pyx_t_4));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_t_4));
    __pyx_t_4 = 0;
    __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, ((PyObject *)__pyx_t_6));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_t_6));
    __pyx_t_6 = 0;
    __pyx_t_6 = <span class='py_c_api'>PyDict_New</span>();<span class='error_goto'> if (unlikely(!__pyx_t_6)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_6));
    __pyx_t_5 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_L);<span class='error_goto'> if (unlikely(!__pyx_t_5)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_5);
    __pyx_t_19 = <span class='py_c_api'>PyInt_FromLong</span>((__pyx_v_N * __pyx_v_M));<span class='error_goto'> if (unlikely(!__pyx_t_19)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_19);
    __pyx_t_20 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_20));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_20, 0, __pyx_t_5);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_5);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_20, 1, __pyx_t_19);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_19);
    __pyx_t_5 = 0;
    __pyx_t_19 = 0;
    if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_t_6, ((PyObject *)__pyx_n_s__shape), ((PyObject *)__pyx_t_20)) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_20)); __pyx_t_20 = 0;
    __pyx_t_20 = <span class='py_c_api'>PyEval_CallObjectWithKeywords</span>(__pyx_t_7, ((PyObject *)__pyx_t_4), ((PyObject *)__pyx_t_6));<span class='error_goto'> if (unlikely(!__pyx_t_20)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 89; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_20);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_6)); __pyx_t_6 = 0;
    __pyx_r = __pyx_t_20;
    __pyx_t_20 = 0;
    goto __pyx_L0;
    break;
  }

  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_5);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_6);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_19);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_20);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&__pyx_type, &__pyx_value, &__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_row);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_ObsList);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_X);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_col);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.unfold");
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_row);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_ObsList);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_X);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_col);
  __pyx_L2:;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_col);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_row);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_XGIVEREF</span></span>(__pyx_r);
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return __pyx_r;
}
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line90")'> 90: </pre>
<pre id='line90' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line91")'> 91: </pre>
<pre id='line91' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line92")'> 92: #Khatri-Rao product</pre>
<pre id='line92' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFaa' onclick='toggleDiv("line93")'> 93: cdef np.ndarray[np.float_t,ndim=2] KRproduct(np.ndarray[np.float_t,ndim=2] A ,np.ndarray[np.float_t,ndim=2] B):</pre>
<pre id='line93' class='code' style='background-color: #FFFFaa'>
/* "CPWOPTcritical.pyx":93
 * 
 * #Khatri-Rao product
 * cdef np.ndarray[np.float_t,ndim=2] KRproduct(np.ndarray[np.float_t,ndim=2] A ,np.ndarray[np.float_t,ndim=2] B):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     """
 *     Khatri-Rao
 */

static  PyArrayObject *__pyx_f_14CPWOPTcritical_KRproduct(PyArrayObject *__pyx_v_A, PyArrayObject *__pyx_v_B) {
  int __pyx_v_x;
  int __pyx_v_y;
  int __pyx_v_i;
  Py_buffer __pyx_bstruct_A;
  Py_ssize_t __pyx_bstride_0_A = 0;
  Py_ssize_t __pyx_bstride_1_A = 0;
  Py_ssize_t __pyx_bshape_0_A = 0;
  Py_ssize_t __pyx_bshape_1_A = 0;
  Py_buffer __pyx_bstruct_B;
  Py_ssize_t __pyx_bstride_0_B = 0;
  Py_ssize_t __pyx_bstride_1_B = 0;
  Py_ssize_t __pyx_bshape_0_B = 0;
  Py_ssize_t __pyx_bshape_1_B = 0;
  PyArrayObject *__pyx_r = NULL;
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannySetupContext</span></span>("KRproduct");
  __pyx_bstruct_A.buf = NULL;
  __pyx_bstruct_B.buf = NULL;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_A, (PyObject*)__pyx_v_A, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 93; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_A = __pyx_bstruct_A.strides[0]; __pyx_bstride_1_A = __pyx_bstruct_A.strides[1];
  __pyx_bshape_0_A = __pyx_bstruct_A.shape[0]; __pyx_bshape_1_A = __pyx_bstruct_A.shape[1];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_B, (PyObject*)__pyx_v_B, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 93; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_B = __pyx_bstruct_B.strides[0]; __pyx_bstride_1_B = __pyx_bstruct_B.strides[1];
  __pyx_bshape_0_B = __pyx_bstruct_B.shape[0]; __pyx_bshape_1_B = __pyx_bstruct_B.shape[1];
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line94")'> 94:     """</pre>
<pre id='line94' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line95")'> 95:     Khatri-Rao</pre>
<pre id='line95' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line96")'> 96:     """</pre>
<pre id='line96' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line97")'> 97:     cdef int x,y</pre>
<pre id='line97' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line98")'> 98:     x,y = A.shape[0],A.shape[1]</pre>
<pre id='line98' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":98
 *     """
 *     cdef int x,y
 *     x,y = A.shape[0],A.shape[1]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     return np.array([np.kron(A[:,i],B[:,i]) for i in xrange(y)]).T
 */
  __pyx_t_1 = (__pyx_v_A->dimensions[0]);
  __pyx_t_2 = (__pyx_v_A->dimensions[1]);
  __pyx_v_x = __pyx_t_1;
  __pyx_v_y = __pyx_t_2;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line99")'> 99: </pre>
<pre id='line99' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF11' onclick='toggleDiv("line100")'> 100:     return np.array([np.kron(A[:,i],B[:,i]) for i in xrange(y)]).T</pre>
<pre id='line100' class='code' style='background-color: #FFFF11'>
  /* "CPWOPTcritical.pyx":100
 *     x,y = A.shape[0],A.shape[1]
 * 
 *     return np.array([np.kron(A[:,i],B[:,i]) for i in xrange(y)]).T             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * 
 */
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(((PyObject *)__pyx_r));
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
  __pyx_t_4 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_3, __pyx_n_s__array);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='py_c_api'>PyList_New</span>(0);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_3));
  __pyx_t_5 = __pyx_v_y;
  for (__pyx_t_6 = 0; __pyx_t_6 <code><</code> __pyx_t_5; __pyx_t_6+=1) {
    __pyx_v_i = __pyx_t_6;
    __pyx_t_7 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_8 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_7, __pyx_n_s__kron);<span class='error_goto'> if (unlikely(!__pyx_t_8)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_8);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_7); __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_i);<span class='error_goto'> if (unlikely(!__pyx_t_7)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    __pyx_t_9 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_9)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_9));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_k_slice_1);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 0, __pyx_k_slice_1);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_k_slice_1);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 1, __pyx_t_7);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_7);
    __pyx_t_7 = 0;
    __pyx_t_7 = <span class='py_c_api'>PyObject_GetItem</span>(((PyObject *)__pyx_v_A), ((PyObject *)__pyx_t_9));<span class='error_goto'> if (!__pyx_t_7) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_7);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_9)); __pyx_t_9 = 0;

  /* "CPWOPTcritical.pyx":100
 *     x,y = A.shape[0],A.shape[1]
 * 
 *     return np.array([np.kron(A[:,i],B[:,i]) for i in xrange(y)]).T             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * 
 */
  __pyx_k_slice_1 = <span class='py_c_api'>PySlice_New</span>(Py_None, Py_None, Py_None);<span class='error_goto'> if (unlikely(!__pyx_k_slice_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_k_slice_1);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_k_slice_1);
    __pyx_t_9 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_i);<span class='error_goto'> if (unlikely(!__pyx_t_9)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_9);
    __pyx_t_10 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_10)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_10));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_k_slice_2);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_10, 0, __pyx_k_slice_2);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_k_slice_2);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_10, 1, __pyx_t_9);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_9);
    __pyx_t_9 = 0;
    __pyx_t_9 = <span class='py_c_api'>PyObject_GetItem</span>(((PyObject *)__pyx_v_B), ((PyObject *)__pyx_t_10));<span class='error_goto'> if (!__pyx_t_9) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_9);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
    __pyx_t_10 = <span class='py_c_api'>PyTuple_New</span>(2);<span class='error_goto'> if (unlikely(!__pyx_t_10)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_10));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_10, 0, __pyx_t_7);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_7);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_10, 1, __pyx_t_9);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_9);
    __pyx_t_7 = 0;
    __pyx_t_9 = 0;
    __pyx_t_9 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_8, ((PyObject *)__pyx_t_10), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_9)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_9);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
    if (unlikely(<span class='py_c_api'>PyList_Append</span>(__pyx_t_3, (PyObject*)__pyx_t_9)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
  }
  __pyx_t_9 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_9)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_9));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_t_3));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_9, 0, ((PyObject *)__pyx_t_3));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_t_3));
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_3)); __pyx_t_3 = 0;
  __pyx_t_3 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_4, ((PyObject *)__pyx_t_9), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_9)); __pyx_t_9 = 0;
  __pyx_t_9 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_3, __pyx_n_s__T);<span class='error_goto'> if (unlikely(!__pyx_t_9)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  if (!(likely(((__pyx_t_9) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_9, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_r = ((PyArrayObject *)__pyx_t_9);
  __pyx_t_9 = 0;
  goto __pyx_L0;

  __pyx_r = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_7);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_10);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&__pyx_type, &__pyx_value, &__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_A);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_B);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.KRproduct");
  __pyx_r = 0;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_A);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_B);
  __pyx_L2:;
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_XGIVEREF</span></span>((PyObject *)__pyx_r);
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return __pyx_r;
}
  __pyx_k_slice_2 = <span class='py_c_api'>PySlice_New</span>(Py_None, Py_None, Py_None);<span class='error_goto'> if (unlikely(!__pyx_k_slice_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 100; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_k_slice_2);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_k_slice_2);
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line101")'> 101: </pre>
<pre id='line101' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line102")'> 102: </pre>
<pre id='line102' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF9f' onclick='toggleDiv("line103")'> 103: cdef tuple unpackAs(np.ndarray[np.float_t,ndim=1] Asv,int su,int sv,int sw):</pre>
<pre id='line103' class='code' style='background-color: #FFFF9f'>
/* "CPWOPTcritical.pyx":103
 * 
 * 
 * cdef tuple unpackAs(np.ndarray[np.float_t,ndim=1] Asv,int su,int sv,int sw):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     cdef np.ndarray[np.float_t,ndim=1] dU,dV,dW
 *     dU = Asv[0:su]
 */

static  PyObject *__pyx_f_14CPWOPTcritical_unpackAs(PyArrayObject *__pyx_v_Asv, int __pyx_v_su, int __pyx_v_sv, int __pyx_v_sw) {
  PyArrayObject *__pyx_v_dU;
  PyArrayObject *__pyx_v_dV;
  PyArrayObject *__pyx_v_dW;
  Py_buffer __pyx_bstruct_Asv;
  Py_ssize_t __pyx_bstride_0_Asv = 0;
  Py_ssize_t __pyx_bshape_0_Asv = 0;
  Py_buffer __pyx_bstruct_dV;
  Py_ssize_t __pyx_bstride_0_dV = 0;
  Py_ssize_t __pyx_bshape_0_dV = 0;
  Py_buffer __pyx_bstruct_dW;
  Py_ssize_t __pyx_bstride_0_dW = 0;
  Py_ssize_t __pyx_bshape_0_dW = 0;
  Py_buffer __pyx_bstruct_dU;
  Py_ssize_t __pyx_bstride_0_dU = 0;
  Py_ssize_t __pyx_bshape_0_dU = 0;
  PyObject *__pyx_r = NULL;
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannySetupContext</span></span>("unpackAs");
  __pyx_v_dU = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_dV = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_dW = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_bstruct_dU.buf = NULL;
  __pyx_bstruct_dV.buf = NULL;
  __pyx_bstruct_dW.buf = NULL;
  __pyx_bstruct_Asv.buf = NULL;
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_Asv, (PyObject*)__pyx_v_Asv, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 103; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_Asv = __pyx_bstruct_Asv.strides[0];
  __pyx_bshape_0_Asv = __pyx_bstruct_Asv.shape[0];
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line104")'> 104:     cdef np.ndarray[np.float_t,ndim=1] dU,dV,dW</pre>
<pre id='line104' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF46' onclick='toggleDiv("line105")'> 105:     dU = Asv[0:su]</pre>
<pre id='line105' class='code' style='background-color: #FFFF46'>
  /* "CPWOPTcritical.pyx":105
 * cdef tuple unpackAs(np.ndarray[np.float_t,ndim=1] Asv,int su,int sv,int sw):
 *     cdef np.ndarray[np.float_t,ndim=1] dU,dV,dW
 *     dU = Asv[0:su]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     dV = Asv[su:su+sv]
 *     dW = Asv[su+sv:]
 */
  __pyx_t_1 = __Pyx_<span class='py_c_api'>PySequence_GetSlice</span>(((PyObject *)__pyx_v_Asv), 0, __pyx_v_su);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 105; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  if (!(likely(((__pyx_t_1) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_1, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 105; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_2 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dU);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dU, (PyObject*)__pyx_t_2, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_3 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_4, &__pyx_t_5, &__pyx_t_6);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dU, (PyObject*)__pyx_v_dU, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_4); Py_XDECREF(__pyx_t_5); Py_XDECREF(__pyx_t_6);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_4, __pyx_t_5, __pyx_t_6);
      }
    }
    __pyx_bstride_0_dU = __pyx_bstruct_dU.strides[0];
    __pyx_bshape_0_dU = __pyx_bstruct_dU.shape[0];
    if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 105; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_dU));
  __pyx_v_dU = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFF46' onclick='toggleDiv("line106")'> 106:     dV = Asv[su:su+sv]</pre>
<pre id='line106' class='code' style='background-color: #FFFF46'>
  /* "CPWOPTcritical.pyx":106
 *     cdef np.ndarray[np.float_t,ndim=1] dU,dV,dW
 *     dU = Asv[0:su]
 *     dV = Asv[su:su+sv]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     dW = Asv[su+sv:]
 *     return (dU,dV,dW)
 */
  __pyx_t_1 = __Pyx_<span class='py_c_api'>PySequence_GetSlice</span>(((PyObject *)__pyx_v_Asv), __pyx_v_su, (__pyx_v_su + __pyx_v_sv));<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 106; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  if (!(likely(((__pyx_t_1) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_1, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 106; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_2 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dV);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dV, (PyObject*)__pyx_t_2, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_3 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_6, &__pyx_t_5, &__pyx_t_4);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dV, (PyObject*)__pyx_v_dV, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_6); Py_XDECREF(__pyx_t_5); Py_XDECREF(__pyx_t_4);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_6, __pyx_t_5, __pyx_t_4);
      }
    }
    __pyx_bstride_0_dV = __pyx_bstruct_dV.strides[0];
    __pyx_bshape_0_dV = __pyx_bstruct_dV.shape[0];
    if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 106; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_dV));
  __pyx_v_dV = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFF46' onclick='toggleDiv("line107")'> 107:     dW = Asv[su+sv:]</pre>
<pre id='line107' class='code' style='background-color: #FFFF46'>
  /* "CPWOPTcritical.pyx":107
 *     dU = Asv[0:su]
 *     dV = Asv[su:su+sv]
 *     dW = Asv[su+sv:]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     return (dU,dV,dW)
 * 
 */
  __pyx_t_1 = __Pyx_<span class='py_c_api'>PySequence_GetSlice</span>(((PyObject *)__pyx_v_Asv), (__pyx_v_su + __pyx_v_sv), PY_SSIZE_T_MAX);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 107; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  if (!(likely(((__pyx_t_1) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_1, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 107; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_2 = ((PyArrayObject *)__pyx_t_1);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dW);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dW, (PyObject*)__pyx_t_2, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_3 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_4, &__pyx_t_5, &__pyx_t_6);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dW, (PyObject*)__pyx_v_dW, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_4); Py_XDECREF(__pyx_t_5); Py_XDECREF(__pyx_t_6);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_4, __pyx_t_5, __pyx_t_6);
      }
    }
    __pyx_bstride_0_dW = __pyx_bstruct_dW.strides[0];
    __pyx_bshape_0_dW = __pyx_bstruct_dW.shape[0];
    if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 107; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_dW));
  __pyx_v_dW = ((PyArrayObject *)__pyx_t_1);
  __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFF33' onclick='toggleDiv("line108")'> 108:     return (dU,dV,dW)</pre>
<pre id='line108' class='code' style='background-color: #FFFF33'>
  /* "CPWOPTcritical.pyx":108
 *     dV = Asv[su:su+sv]
 *     dW = Asv[su+sv:]
 *     return (dU,dV,dW)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * def Gradient(np.ndarray[np.float_t,ndim=1] X not None,np.ndarray[np.int_t,ndim=1] Obs not None,tuple As,np.ndarray[np.float_t,ndim=2] L not None,tuple shape,int R,int mode):
 */
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(((PyObject *)__pyx_r));
  __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(3);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 108; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_1));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_dU));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, ((PyObject *)__pyx_v_dU));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_dU));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_dV));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 1, ((PyObject *)__pyx_v_dV));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_dV));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_dW));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 2, ((PyObject *)__pyx_v_dW));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_dW));
  __pyx_r = __pyx_t_1;
  __pyx_t_1 = 0;
  goto __pyx_L0;

  __pyx_r = ((PyObject*)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&__pyx_type, &__pyx_value, &__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Asv);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dV);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dW);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dU);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.unpackAs");
  __pyx_r = 0;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Asv);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dV);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dW);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dU);
  __pyx_L2:;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_dU);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_dV);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_dW);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_XGIVEREF</span></span>(__pyx_r);
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return __pyx_r;
}
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line109")'> 109: </pre>
<pre id='line109' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF0f' onclick='toggleDiv("line110")'> 110: def Gradient(np.ndarray[np.float_t,ndim=1] X not None,np.ndarray[np.int_t,ndim=1] Obs not None,tuple As,np.ndarray[np.float_t,ndim=2] L not None,tuple shape,int R,int mode):</pre>
<pre id='line110' class='code' style='background-color: #FFFF0f'>
/* "CPWOPTcritical.pyx":110
 *     return (dU,dV,dW)
 * 
 * def Gradient(np.ndarray[np.float_t,ndim=1] X not None,np.ndarray[np.int_t,ndim=1] Obs not None,tuple As,np.ndarray[np.float_t,ndim=2] L not None,tuple shape,int R,int mode):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     #Ls must be given as CSR_matrix
 *     #Obs must be given as list of coordinate tuples
 */

static PyObject *__pyx_pf_14CPWOPTcritical_2Gradient(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_14CPWOPTcritical_2Gradient = {<span class='pyx_macro_api'>__Pyx_NAMESTR</span>("Gradient"), (PyCFunction)__pyx_pf_14CPWOPTcritical_2Gradient, METH_VARARGS|METH_KEYWORDS, <span class='pyx_macro_api'>__Pyx_DOCSTR</span>(0)};
static PyObject *__pyx_pf_14CPWOPTcritical_2Gradient(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_X = 0;
  PyArrayObject *__pyx_v_Obs = 0;
  PyObject *__pyx_v_As = 0;
  PyArrayObject *__pyx_v_L = 0;
  PyObject *__pyx_v_shape = 0;
  int __pyx_v_R;
  int __pyx_v_mode;
  int __pyx_v_n;
  int __pyx_v_m;
  int __pyx_v_l;
  PyArrayObject *__pyx_v_U;
  PyArrayObject *__pyx_v_V;
  PyArrayObject *__pyx_v_W;
  PyArrayObject *__pyx_v_dA;
  PyObject *__pyx_v_XO;
  PyObject *__pyx_v_Left;
  PyObject *__pyx_v_Left_f;
  Py_buffer __pyx_bstruct_L;
  Py_ssize_t __pyx_bstride_0_L = 0;
  Py_ssize_t __pyx_bstride_1_L = 0;
  Py_ssize_t __pyx_bshape_0_L = 0;
  Py_ssize_t __pyx_bshape_1_L = 0;
  Py_buffer __pyx_bstruct_U;
  Py_ssize_t __pyx_bstride_0_U = 0;
  Py_ssize_t __pyx_bstride_1_U = 0;
  Py_ssize_t __pyx_bshape_0_U = 0;
  Py_ssize_t __pyx_bshape_1_U = 0;
  Py_buffer __pyx_bstruct_W;
  Py_ssize_t __pyx_bstride_0_W = 0;
  Py_ssize_t __pyx_bstride_1_W = 0;
  Py_ssize_t __pyx_bshape_0_W = 0;
  Py_ssize_t __pyx_bshape_1_W = 0;
  Py_buffer __pyx_bstruct_V;
  Py_ssize_t __pyx_bstride_0_V = 0;
  Py_ssize_t __pyx_bstride_1_V = 0;
  Py_ssize_t __pyx_bshape_0_V = 0;
  Py_ssize_t __pyx_bshape_1_V = 0;
  Py_buffer __pyx_bstruct_X;
  Py_ssize_t __pyx_bstride_0_X = 0;
  Py_ssize_t __pyx_bshape_0_X = 0;
  Py_buffer __pyx_bstruct_Obs;
  Py_ssize_t __pyx_bstride_0_Obs = 0;
  Py_ssize_t __pyx_bshape_0_Obs = 0;
  Py_buffer __pyx_bstruct_dA;
  Py_ssize_t __pyx_bstride_0_dA = 0;
  Py_ssize_t __pyx_bstride_1_dA = 0;
  Py_ssize_t __pyx_bshape_0_dA = 0;
  Py_ssize_t __pyx_bshape_1_dA = 0;
  PyObject *__pyx_r = NULL;
  static PyObject **__pyx_pyargnames[] = {&__pyx_n_s__X,&__pyx_n_s__Obs,&__pyx_n_s__As,&__pyx_n_s__L,&__pyx_n_s__shape,&__pyx_n_s__R,&__pyx_n_s__mode,0};
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannySetupContext</span></span>("Gradient");
  __pyx_self = __pyx_self;
  if (unlikely(__pyx_kwds)) {
    Py_ssize_t kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
    PyObject* values[7] = {0,0,0,0,0,0,0};
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  7: values[6] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6);
      case  6: values[5] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5);
      case  5: values[4] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4);
      case  4: values[3] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3);
      case  3: values[2] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2);
      case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
      case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      case  0: break;
      default: goto __pyx_L5_argtuple_error;
    }
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  0:
      values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__X);
      if (likely(values[0])) kw_args--;
      else goto __pyx_L5_argtuple_error;
      case  1:
      values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__Obs);
      if (likely(values[1])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("Gradient", 1, 7, 7, 1);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  2:
      values[2] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__As);
      if (likely(values[2])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("Gradient", 1, 7, 7, 2);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  3:
      values[3] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__L);
      if (likely(values[3])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("Gradient", 1, 7, 7, 3);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  4:
      values[4] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__shape);
      if (likely(values[4])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("Gradient", 1, 7, 7, 4);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  5:
      values[5] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__R);
      if (likely(values[5])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("Gradient", 1, 7, 7, 5);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
      case  6:
      values[6] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__mode);
      if (likely(values[6])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("Gradient", 1, 7, 7, 6);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
    }
    if (unlikely(kw_args > 0)) {
      if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args), "Gradient") <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    }
    __pyx_v_X = ((PyArrayObject *)values[0]);
    __pyx_v_Obs = ((PyArrayObject *)values[1]);
    __pyx_v_As = ((PyObject*)values[2]);
    __pyx_v_L = ((PyArrayObject *)values[3]);
    __pyx_v_shape = ((PyObject*)values[4]);
    __pyx_v_R = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(values[5]);<span class='error_goto'> if (unlikely((__pyx_v_R == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    __pyx_v_mode = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(values[6]);<span class='error_goto'> if (unlikely((__pyx_v_mode == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
  } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 7) {
    goto __pyx_L5_argtuple_error;
  } else {
    __pyx_v_X = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0));
    __pyx_v_Obs = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1));
    __pyx_v_As = ((PyObject*)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 2));
    __pyx_v_L = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 3));
    __pyx_v_shape = ((PyObject*)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 4));
    __pyx_v_R = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 5));<span class='error_goto'> if (unlikely((__pyx_v_R == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    __pyx_v_mode = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 6));<span class='error_goto'> if (unlikely((__pyx_v_mode == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("Gradient", 1, 7, 7, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args));<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.Gradient");
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_v_U = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_V = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_W = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_dA = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_XO = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_Left = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_Left_f = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_bstruct_U.buf = NULL;
  __pyx_bstruct_V.buf = NULL;
  __pyx_bstruct_W.buf = NULL;
  __pyx_bstruct_dA.buf = NULL;
  __pyx_bstruct_X.buf = NULL;
  __pyx_bstruct_Obs.buf = NULL;
  __pyx_bstruct_L.buf = NULL;
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_X), __pyx_ptype_5numpy_ndarray, 0, "X", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_Obs), __pyx_ptype_5numpy_ndarray, 0, "Obs", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_As), (&PyTuple_Type), 1, "As", 1)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_L), __pyx_ptype_5numpy_ndarray, 0, "L", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_shape), (&PyTuple_Type), 1, "shape", 1)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_X, (PyObject*)__pyx_v_X, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_X = __pyx_bstruct_X.strides[0];
  __pyx_bshape_0_X = __pyx_bstruct_X.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_Obs, (PyObject*)__pyx_v_Obs, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_Obs = __pyx_bstruct_Obs.strides[0];
  __pyx_bshape_0_Obs = __pyx_bstruct_Obs.shape[0];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_L, (PyObject*)__pyx_v_L, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_L = __pyx_bstruct_L.strides[0]; __pyx_bstride_1_L = __pyx_bstruct_L.strides[1];
  __pyx_bshape_0_L = __pyx_bstruct_L.shape[0]; __pyx_bshape_1_L = __pyx_bstruct_L.shape[1];

  /* "CPWOPTcritical.pyx":110
 *     return (dU,dV,dW)
 * 
 * def Gradient(np.ndarray[np.float_t,ndim=1] X not None,np.ndarray[np.int_t,ndim=1] Obs not None,tuple As,np.ndarray[np.float_t,ndim=2] L not None,tuple shape,int R,int mode):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     #Ls must be given as CSR_matrix
 *     #Obs must be given as list of coordinate tuples
 */
  __pyx_t_2 = PyCFunction_NewEx(&__pyx_mdef_14CPWOPTcritical_2Gradient, NULL, __pyx_n_s__CPWOPTcritical);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  if (<span class='py_c_api'>PyObject_SetAttr</span>(__pyx_m, __pyx_n_s__Gradient, __pyx_t_2) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 110; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line111")'> 111:     #Ls must be given as CSR_matrix</pre>
<pre id='line111' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line112")'> 112:     #Obs must be given as list of coordinate tuples</pre>
<pre id='line112' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line113")'> 113:     #X is given as dense vector with only observed elements</pre>
<pre id='line113' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line114")'> 114:     #print "Gradient starat"</pre>
<pre id='line114' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line115")'> 115: </pre>
<pre id='line115' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line116")'> 116: </pre>
<pre id='line116' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line117")'> 117:     cdef int n,m,l,ind,i,j,k</pre>
<pre id='line117' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line118")'> 118:     cdef float val</pre>
<pre id='line118' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line119")'> 119:     cdef np.ndarray[np.float_t,ndim=2] U,V,W,dA</pre>
<pre id='line119' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line120")'> 120:     #cdef np.ndarray[np.float_t,ndim=1] vU,vV,vW</pre>
<pre id='line120' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line121")'> 121: </pre>
<pre id='line121' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF31' onclick='toggleDiv("line122")'> 122:     (n,m,l) = shape</pre>
<pre id='line122' class='code' style='background-color: #FFFF31'>
  /* "CPWOPTcritical.pyx":122
 *     #cdef np.ndarray[np.float_t,ndim=1] vU,vV,vW
 * 
 *     (n,m,l) = shape             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     U=As[0]
 */
  if (likely(((PyObject *)__pyx_v_shape) != Py_None) && likely(<span class='py_macro_api'>PyTuple_GET_SIZE</span>(((PyObject *)__pyx_v_shape)) == 3)) {
    PyObject* tuple = ((PyObject *)__pyx_v_shape);
    __pyx_t_1 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(tuple, 0); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_1);
    __pyx_t_4 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(__pyx_t_1);<span class='error_goto'> if (unlikely((__pyx_t_4 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 122; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_2 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(tuple, 1); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
    __pyx_t_5 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(__pyx_t_2);<span class='error_goto'> if (unlikely((__pyx_t_5 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 122; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    __pyx_t_3 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(tuple, 2); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_3);
    __pyx_t_6 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(__pyx_t_3);<span class='error_goto'> if (unlikely((__pyx_t_6 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 122; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_v_n = __pyx_t_4;
    __pyx_v_m = __pyx_t_5;
    __pyx_v_l = __pyx_t_6;
  } else {
    <span class='pyx_c_api'>__Pyx_UnpackTupleError</span>(((PyObject *)__pyx_v_shape), 3);
   <span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 122; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line123")'> 123: </pre>
<pre id='line123' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF4d' onclick='toggleDiv("line124")'> 124:     U=As[0]</pre>
<pre id='line124' class='code' style='background-color: #FFFF4d'>
  /* "CPWOPTcritical.pyx":124
 *     (n,m,l) = shape
 * 
 *     U=As[0]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     V=As[1]
 *     W=As[2]
 */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetItemInt_Tuple</span>(((PyObject *)__pyx_v_As), 0, sizeof(long), PyInt_FromLong);<span class='error_goto'> if (!__pyx_t_3) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 124; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
  if (!(likely(((__pyx_t_3) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_3, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 124; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_U);
    __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_U, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_6 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_8, &__pyx_t_9, &__pyx_t_10);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_U, (PyObject*)__pyx_v_U, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_8, __pyx_t_9, __pyx_t_10);
      }
    }
    __pyx_bstride_0_U = __pyx_bstruct_U.strides[0]; __pyx_bstride_1_U = __pyx_bstruct_U.strides[1];
    __pyx_bshape_0_U = __pyx_bstruct_U.shape[0]; __pyx_bshape_1_U = __pyx_bstruct_U.shape[1];
    if (unlikely(__pyx_t_6 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 124; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_7 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_U));
  __pyx_v_U = ((PyArrayObject *)__pyx_t_3);
  __pyx_t_3 = 0;
</pre><pre class='line' style='background-color: #FFFF4d' onclick='toggleDiv("line125")'> 125:     V=As[1]</pre>
<pre id='line125' class='code' style='background-color: #FFFF4d'>
  /* "CPWOPTcritical.pyx":125
 * 
 *     U=As[0]
 *     V=As[1]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     W=As[2]
 * 
 */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetItemInt_Tuple</span>(((PyObject *)__pyx_v_As), 1, sizeof(long), PyInt_FromLong);<span class='error_goto'> if (!__pyx_t_3) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 125; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
  if (!(likely(((__pyx_t_3) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_3, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 125; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_V);
    __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_V, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_6 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_10, &__pyx_t_9, &__pyx_t_8);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_V, (PyObject*)__pyx_v_V, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_8);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_10, __pyx_t_9, __pyx_t_8);
      }
    }
    __pyx_bstride_0_V = __pyx_bstruct_V.strides[0]; __pyx_bstride_1_V = __pyx_bstruct_V.strides[1];
    __pyx_bshape_0_V = __pyx_bstruct_V.shape[0]; __pyx_bshape_1_V = __pyx_bstruct_V.shape[1];
    if (unlikely(__pyx_t_6 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 125; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_7 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_V));
  __pyx_v_V = ((PyArrayObject *)__pyx_t_3);
  __pyx_t_3 = 0;
</pre><pre class='line' style='background-color: #FFFF4d' onclick='toggleDiv("line126")'> 126:     W=As[2]</pre>
<pre id='line126' class='code' style='background-color: #FFFF4d'>
  /* "CPWOPTcritical.pyx":126
 *     U=As[0]
 *     V=As[1]
 *     W=As[2]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     XO = HadamardProdOfSparseTensor(U,V,W,Obs)
 */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetItemInt_Tuple</span>(((PyObject *)__pyx_v_As), 2, sizeof(long), PyInt_FromLong);<span class='error_goto'> if (!__pyx_t_3) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 126; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
  if (!(likely(((__pyx_t_3) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_3, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 126; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_7 = ((PyArrayObject *)__pyx_t_3);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_W);
    __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_W, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
    if (unlikely(__pyx_t_6 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_8, &__pyx_t_9, &__pyx_t_10);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_W, (PyObject*)__pyx_v_W, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_8, __pyx_t_9, __pyx_t_10);
      }
    }
    __pyx_bstride_0_W = __pyx_bstruct_W.strides[0]; __pyx_bstride_1_W = __pyx_bstruct_W.strides[1];
    __pyx_bshape_0_W = __pyx_bstruct_W.shape[0]; __pyx_bshape_1_W = __pyx_bstruct_W.shape[1];
    if (unlikely(__pyx_t_6 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 126; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_7 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_W));
  __pyx_v_W = ((PyArrayObject *)__pyx_t_3);
  __pyx_t_3 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line127")'> 127: </pre>
<pre id='line127' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF4d' onclick='toggleDiv("line128")'> 128:     XO = HadamardProdOfSparseTensor(U,V,W,Obs)</pre>
<pre id='line128' class='code' style='background-color: #FFFF4d'>
  /* "CPWOPTcritical.pyx":128
 *     W=As[2]
 * 
 *     XO = HadamardProdOfSparseTensor(U,V,W,Obs)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     Left = XO - X
 */
  __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s_3);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 128; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
  __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(4);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 128; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_2));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_U));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, ((PyObject *)__pyx_v_U));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_U));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_V));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 1, ((PyObject *)__pyx_v_V));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_V));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_W));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 2, ((PyObject *)__pyx_v_W));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_W));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_Obs));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 3, ((PyObject *)__pyx_v_Obs));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_Obs));
  __pyx_t_1 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_3, ((PyObject *)__pyx_t_2), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 128; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_XO);
  __pyx_v_XO = __pyx_t_1;
  __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line129")'> 129: </pre>
<pre id='line129' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF9f' onclick='toggleDiv("line130")'> 130:     Left = XO - X</pre>
<pre id='line130' class='code' style='background-color: #FFFF9f'>
  /* "CPWOPTcritical.pyx":130
 *     XO = HadamardProdOfSparseTensor(U,V,W,Obs)
 * 
 *     Left = XO - X             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     Left_f = unfold(Left,mode,shape,Obs)
 * 
 */
  __pyx_t_1 = <span class='py_c_api'>PyNumber_Subtract</span>(__pyx_v_XO, ((PyObject *)__pyx_v_X));<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 130; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_Left);
  __pyx_v_Left = __pyx_t_1;
  __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFF44' onclick='toggleDiv("line131")'> 131:     Left_f = unfold(Left,mode,shape,Obs)</pre>
<pre id='line131' class='code' style='background-color: #FFFF44'>
  /* "CPWOPTcritical.pyx":131
 * 
 *     Left = XO - X
 *     Left_f = unfold(Left,mode,shape,Obs)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     if mode==0:
 */
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__unfold);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 131; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  __pyx_t_2 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_mode);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 131; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  __pyx_t_3 = <span class='py_c_api'>PyTuple_New</span>(4);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 131; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_3));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_Left);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 0, __pyx_v_Left);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_v_Left);
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 1, __pyx_t_2);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_shape));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 2, ((PyObject *)__pyx_v_shape));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_shape));
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_Obs));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_3, 3, ((PyObject *)__pyx_v_Obs));
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_Obs));
  __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_1, ((PyObject *)__pyx_t_3), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 131; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_3)); __pyx_t_3 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_Left_f);
  __pyx_v_Left_f = __pyx_t_2;
  __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line132")'> 132: </pre>
<pre id='line132' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line133")'> 133:     if mode==0:</pre>
<pre id='line133' class='code' style='background-color: #FFFFff'>
    /* "CPWOPTcritical.pyx":133
 *     Left_f = unfold(Left,mode,shape,Obs)
 * 
 *     if mode==0:             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         dA = 2*Left_f.dot(KRproduct(W,V)) + L.dot(U)
 *     elif mode==1:
 */
    case 0:
</pre><pre class='line' style='background-color: #FFFF1f' onclick='toggleDiv("line134")'> 134:         dA = 2*Left_f.dot(KRproduct(W,V)) + L.dot(U)</pre>
<pre id='line134' class='code' style='background-color: #FFFF1f'>
    /* "CPWOPTcritical.pyx":134
 * 
 *     if mode==0:
 *         dA = 2*Left_f.dot(KRproduct(W,V)) + L.dot(U)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     elif mode==1:
 *         dA = 2*Left_f.dot(KRproduct(W,U)) + L.dot(V)
 */
    __pyx_t_2 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_v_Left_f, __pyx_n_s__dot);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    __pyx_t_3 = ((PyObject *)__pyx_f_14CPWOPTcritical_KRproduct(((PyArrayObject *)__pyx_v_W), ((PyArrayObject *)__pyx_v_V)));<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
    __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_1));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_3);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_3);
    __pyx_t_3 = 0;
    __pyx_t_3 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_2, ((PyObject *)__pyx_t_1), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_1)); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_int_2, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = <span class='py_c_api'>PyObject_GetAttr</span>(((PyObject *)__pyx_v_L), __pyx_n_s__dot);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_2));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_U));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, ((PyObject *)__pyx_v_U));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_U));
    __pyx_t_11 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_3, ((PyObject *)__pyx_t_2), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_11)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_11);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_1, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_2, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_7 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dA);
      __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dA, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_6 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_10, &__pyx_t_9, &__pyx_t_8);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dA, (PyObject*)__pyx_v_dA, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_8);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_10, __pyx_t_9, __pyx_t_8);
        }
      }
      __pyx_bstride_0_dA = __pyx_bstruct_dA.strides[0]; __pyx_bstride_1_dA = __pyx_bstruct_dA.strides[1];
      __pyx_bshape_0_dA = __pyx_bstruct_dA.shape[0]; __pyx_bshape_1_dA = __pyx_bstruct_dA.shape[1];
      if (unlikely(__pyx_t_6 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 134; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_dA));
    __pyx_v_dA = ((PyArrayObject *)__pyx_t_2);
    __pyx_t_2 = 0;
    break;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line135")'> 135:     elif mode==1:</pre>
<pre id='line135' class='code' style='background-color: #FFFFff'>
  /* "CPWOPTcritical.pyx":135
 *     if mode==0:
 *         dA = 2*Left_f.dot(KRproduct(W,V)) + L.dot(U)
 *     elif mode==1:             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         dA = 2*Left_f.dot(KRproduct(W,U)) + L.dot(V)
 *     else:
 */
  switch (__pyx_v_mode) {

    /* "CPWOPTcritical.pyx":135
 *     if mode==0:
 *         dA = 2*Left_f.dot(KRproduct(W,V)) + L.dot(U)
 *     elif mode==1:             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         dA = 2*Left_f.dot(KRproduct(W,U)) + L.dot(V)
 *     else:
 */
    case 1:
</pre><pre class='line' style='background-color: #FFFF1f' onclick='toggleDiv("line136")'> 136:         dA = 2*Left_f.dot(KRproduct(W,U)) + L.dot(V)</pre>
<pre id='line136' class='code' style='background-color: #FFFF1f'>
    /* "CPWOPTcritical.pyx":136
 *         dA = 2*Left_f.dot(KRproduct(W,V)) + L.dot(U)
 *     elif mode==1:
 *         dA = 2*Left_f.dot(KRproduct(W,U)) + L.dot(V)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     else:
 *         dA = 2*Left_f.dot(KRproduct(V,U)) + L.dot(W)
 */
    __pyx_t_2 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_v_Left_f, __pyx_n_s__dot);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    __pyx_t_11 = ((PyObject *)__pyx_f_14CPWOPTcritical_KRproduct(((PyArrayObject *)__pyx_v_W), ((PyArrayObject *)__pyx_v_U)));<span class='error_goto'> if (unlikely(!__pyx_t_11)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_11);
    __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_1));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_11);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_11);
    __pyx_t_11 = 0;
    __pyx_t_11 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_2, ((PyObject *)__pyx_t_1), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_11)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_11);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_1)); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_int_2, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
    __pyx_t_11 = <span class='py_c_api'>PyObject_GetAttr</span>(((PyObject *)__pyx_v_L), __pyx_n_s__dot);<span class='error_goto'> if (unlikely(!__pyx_t_11)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_11);
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_2));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_V));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, ((PyObject *)__pyx_v_V));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_V));
    __pyx_t_3 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_11, ((PyObject *)__pyx_t_2), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_1, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_2, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_7 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dA);
      __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dA, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_6 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_8, &__pyx_t_9, &__pyx_t_10);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dA, (PyObject*)__pyx_v_dA, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_8); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_10);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_8, __pyx_t_9, __pyx_t_10);
        }
      }
      __pyx_bstride_0_dA = __pyx_bstruct_dA.strides[0]; __pyx_bstride_1_dA = __pyx_bstruct_dA.strides[1];
      __pyx_bshape_0_dA = __pyx_bstruct_dA.shape[0]; __pyx_bshape_1_dA = __pyx_bstruct_dA.shape[1];
      if (unlikely(__pyx_t_6 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 136; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_dA));
    __pyx_v_dA = ((PyArrayObject *)__pyx_t_2);
    __pyx_t_2 = 0;
    break;
    default:
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line137")'> 137:     else:</pre>
<pre id='line137' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF1f' onclick='toggleDiv("line138")'> 138:         dA = 2*Left_f.dot(KRproduct(V,U)) + L.dot(W)</pre>
<pre id='line138' class='code' style='background-color: #FFFF1f'>
    /* "CPWOPTcritical.pyx":138
 *         dA = 2*Left_f.dot(KRproduct(W,U)) + L.dot(V)
 *     else:
 *         dA = 2*Left_f.dot(KRproduct(V,U)) + L.dot(W)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     #print "Gradient end"
 *     return dA.squeeze()
 */
    __pyx_t_2 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_v_Left_f, __pyx_n_s__dot);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    __pyx_t_3 = ((PyObject *)__pyx_f_14CPWOPTcritical_KRproduct(((PyArrayObject *)__pyx_v_V), ((PyArrayObject *)__pyx_v_U)));<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
    __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_1));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_t_3);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_3);
    __pyx_t_3 = 0;
    __pyx_t_3 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_2, ((PyObject *)__pyx_t_1), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_1)); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_int_2, __pyx_t_3);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    __pyx_t_3 = <span class='py_c_api'>PyObject_GetAttr</span>(((PyObject *)__pyx_v_L), __pyx_n_s__dot);<span class='error_goto'> if (unlikely(!__pyx_t_3)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_3);
    __pyx_t_2 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_2));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_W));
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_2, 0, ((PyObject *)__pyx_v_W));
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(((PyObject *)__pyx_v_W));
    __pyx_t_11 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_3, ((PyObject *)__pyx_t_2), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_11)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_11);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_3); __pyx_t_3 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_2)); __pyx_t_2 = 0;
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_1, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
    if (!(likely(((__pyx_t_2) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_2, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    __pyx_t_7 = ((PyArrayObject *)__pyx_t_2);
    {
      __Pyx_BufFmt_StackElem __pyx_stack[1];
      <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dA);
      __pyx_t_6 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dA, (PyObject*)__pyx_t_7, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack);
      if (unlikely(__pyx_t_6 <code><</code> 0)) {
        <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_10, &__pyx_t_9, &__pyx_t_8);
        if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_dA, (PyObject*)__pyx_v_dA, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 2, 0, __pyx_stack) == -1)) {
          Py_XDECREF(__pyx_t_10); Py_XDECREF(__pyx_t_9); Py_XDECREF(__pyx_t_8);
          <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
        } else {
          <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_10, __pyx_t_9, __pyx_t_8);
        }
      }
      __pyx_bstride_0_dA = __pyx_bstruct_dA.strides[0]; __pyx_bstride_1_dA = __pyx_bstruct_dA.strides[1];
      __pyx_bshape_0_dA = __pyx_bstruct_dA.shape[0]; __pyx_bshape_1_dA = __pyx_bstruct_dA.shape[1];
      if (unlikely(__pyx_t_6 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 138; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    }
    __pyx_t_7 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_dA));
    __pyx_v_dA = ((PyArrayObject *)__pyx_t_2);
    __pyx_t_2 = 0;
    break;
  }
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line139")'> 139:     #print "Gradient end"</pre>
<pre id='line139' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF24' onclick='toggleDiv("line140")'> 140:     return dA.squeeze()</pre>
<pre id='line140' class='code' style='background-color: #FFFF24'>
  /* "CPWOPTcritical.pyx":140
 *         dA = 2*Left_f.dot(KRproduct(V,U)) + L.dot(W)
 *     #print "Gradient end"
 *     return dA.squeeze()             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     #return squeezeAs((dU,dV,dW))
 */
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  __pyx_t_2 = <span class='py_c_api'>PyObject_GetAttr</span>(((PyObject *)__pyx_v_dA), __pyx_n_s__squeeze);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 140; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  __pyx_t_11 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_2, ((PyObject *)__pyx_empty_tuple), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_11)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 140; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_11);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_r = __pyx_t_11;
  __pyx_t_11 = 0;
  goto __pyx_L0;

  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_3);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_11);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&__pyx_type, &__pyx_value, &__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_L);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_U);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_W);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_V);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_X);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Obs);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dA);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.Gradient");
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_L);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_U);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_W);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_V);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_X);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Obs);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_dA);
  __pyx_L2:;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_U);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_V);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_W);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_dA);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_XO);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_Left);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_Left_f);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_XGIVEREF</span></span>(__pyx_r);
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return __pyx_r;
}
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line141")'> 141: </pre>
<pre id='line141' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line142")'> 142:     #return squeezeAs((dU,dV,dW))</pre>
<pre id='line142' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line143")'> 143: @cython.boundscheck(False)</pre>
<pre id='line143' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF27' onclick='toggleDiv("line144")'> 144: def CompressSparseTensorToVector(np.ndarray[np.float_t,ndim=3] X not None, np.ndarray[np.int_t,ndim=1] ObservedList not None):</pre>
<pre id='line144' class='code' style='background-color: #FFFF27'>
/* "CPWOPTcritical.pyx":144
 *     #return squeezeAs((dU,dV,dW))
 * @cython.boundscheck(False)
 * def CompressSparseTensorToVector(np.ndarray[np.float_t,ndim=3] X not None, np.ndarray[np.int_t,ndim=1] ObservedList not None):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     cdef int size
 *     cdef np.ndarray[np.float_t,ndim=1] Xdense
 */

static PyObject *__pyx_pf_14CPWOPTcritical_3CompressSparseTensorToVector(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_14CPWOPTcritical_3CompressSparseTensorToVector = {<span class='pyx_macro_api'>__Pyx_NAMESTR</span>("CompressSparseTensorToVector"), (PyCFunction)__pyx_pf_14CPWOPTcritical_3CompressSparseTensorToVector, METH_VARARGS|METH_KEYWORDS, <span class='pyx_macro_api'>__Pyx_DOCSTR</span>(0)};
static PyObject *__pyx_pf_14CPWOPTcritical_3CompressSparseTensorToVector(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyArrayObject *__pyx_v_X = 0;
  PyArrayObject *__pyx_v_ObservedList = 0;
  int __pyx_v_size;
  PyArrayObject *__pyx_v_Xdense;
  PyObject *__pyx_v_n;
  PyObject *__pyx_v_i;
  PyObject *__pyx_v_j;
  PyObject *__pyx_v_k;
  Py_buffer __pyx_bstruct_ObservedList;
  Py_ssize_t __pyx_bstride_0_ObservedList = 0;
  Py_ssize_t __pyx_bshape_0_ObservedList = 0;
  Py_buffer __pyx_bstruct_X;
  Py_ssize_t __pyx_bstride_0_X = 0;
  Py_ssize_t __pyx_bstride_1_X = 0;
  Py_ssize_t __pyx_bstride_2_X = 0;
  Py_ssize_t __pyx_bshape_0_X = 0;
  Py_ssize_t __pyx_bshape_1_X = 0;
  Py_ssize_t __pyx_bshape_2_X = 0;
  Py_buffer __pyx_bstruct_Xdense;
  Py_ssize_t __pyx_bstride_0_Xdense = 0;
  Py_ssize_t __pyx_bshape_0_Xdense = 0;
  PyObject *__pyx_r = NULL;
  static PyObject **__pyx_pyargnames[] = {&__pyx_n_s__X,&__pyx_n_s__ObservedList,0};
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannySetupContext</span></span>("CompressSparseTensorToVector");
  __pyx_self = __pyx_self;
  if (unlikely(__pyx_kwds)) {
    Py_ssize_t kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
    PyObject* values[2] = {0,0};
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
      case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      case  0: break;
      default: goto __pyx_L5_argtuple_error;
    }
    switch (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)) {
      case  0:
      values[0] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__X);
      if (likely(values[0])) kw_args--;
      else goto __pyx_L5_argtuple_error;
      case  1:
      values[1] = <span class='py_c_api'>PyDict_GetItem</span>(__pyx_kwds, __pyx_n_s__ObservedList);
      if (likely(values[1])) kw_args--;
      else {
        <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("CompressSparseTensorToVector", 1, 2, 2, 1);<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
      }
    }
    if (unlikely(kw_args > 0)) {
      if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args), "CompressSparseTensorToVector") <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
    }
    __pyx_v_X = ((PyArrayObject *)values[0]);
    __pyx_v_ObservedList = ((PyArrayObject *)values[1]);
  } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 2) {
    goto __pyx_L5_argtuple_error;
  } else {
    __pyx_v_X = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0));
    __pyx_v_ObservedList = ((PyArrayObject *)<span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1));
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("CompressSparseTensorToVector", 1, 2, 2, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args));<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L3_error;}</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.CompressSparseTensorToVector");
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_v_Xdense = ((PyArrayObject *)Py_None); <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_n = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_i = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_j = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_v_k = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  __pyx_bstruct_Xdense.buf = NULL;
  __pyx_bstruct_X.buf = NULL;
  __pyx_bstruct_ObservedList.buf = NULL;
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_X), __pyx_ptype_5numpy_ndarray, 0, "X", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  if (unlikely(!<span class='pyx_c_api'>__Pyx_ArgTypeTest</span>(((PyObject *)__pyx_v_ObservedList), __pyx_ptype_5numpy_ndarray, 0, "ObservedList", 0)))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_X, (PyObject*)__pyx_v_X, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 3, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_X = __pyx_bstruct_X.strides[0]; __pyx_bstride_1_X = __pyx_bstruct_X.strides[1]; __pyx_bstride_2_X = __pyx_bstruct_X.strides[2];
  __pyx_bshape_0_X = __pyx_bstruct_X.shape[0]; __pyx_bshape_1_X = __pyx_bstruct_X.shape[1]; __pyx_bshape_2_X = __pyx_bstruct_X.shape[2];
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_ObservedList, (PyObject*)__pyx_v_ObservedList, &__Pyx_TypeInfo_nn___pyx_t_5numpy_int_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_bstride_0_ObservedList = __pyx_bstruct_ObservedList.strides[0];
  __pyx_bshape_0_ObservedList = __pyx_bstruct_ObservedList.shape[0];

  /* "CPWOPTcritical.pyx":144
 *     #return squeezeAs((dU,dV,dW))
 * @cython.boundscheck(False)
 * def CompressSparseTensorToVector(np.ndarray[np.float_t,ndim=3] X not None, np.ndarray[np.int_t,ndim=1] ObservedList not None):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     cdef int size
 *     cdef np.ndarray[np.float_t,ndim=1] Xdense
 */
  __pyx_t_2 = PyCFunction_NewEx(&__pyx_mdef_14CPWOPTcritical_3CompressSparseTensorToVector, NULL, __pyx_n_s__CPWOPTcritical);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  if (<span class='py_c_api'>PyObject_SetAttr</span>(__pyx_m, __pyx_n_s_18, __pyx_t_2) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 144; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line145")'> 145:     cdef int size</pre>
<pre id='line145' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line146")'> 146:     cdef np.ndarray[np.float_t,ndim=1] Xdense</pre>
<pre id='line146' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF4f' onclick='toggleDiv("line147")'> 147:     size = ObservedList.size / 3</pre>
<pre id='line147' class='code' style='background-color: #FFFF4f'>
  /* "CPWOPTcritical.pyx":147
 *     cdef int size
 *     cdef np.ndarray[np.float_t,ndim=1] Xdense
 *     size = ObservedList.size / 3             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 *     Xdense = np.zeros(size)
 */
  __pyx_t_1 = <span class='py_c_api'>PyObject_GetAttr</span>(((PyObject *)__pyx_v_ObservedList), __pyx_n_s__size);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 147; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  __pyx_t_2 = __Pyx_<span class='py_c_api'>PyNumber_Divide</span>(__pyx_t_1, __pyx_int_3);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 147; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_3 = __Pyx_<span class='py_c_api'>PyInt_AsInt</span>(__pyx_t_2);<span class='error_goto'> if (unlikely((__pyx_t_3 == (int)-1) && <span class='py_c_api'>PyErr_Occurred</span>())) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 147; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_size = __pyx_t_3;
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line148")'> 148: </pre>
<pre id='line148' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFF2c' onclick='toggleDiv("line149")'> 149:     Xdense = np.zeros(size)</pre>
<pre id='line149' class='code' style='background-color: #FFFF2c'>
  /* "CPWOPTcritical.pyx":149
 *     size = ObservedList.size / 3
 * 
 *     Xdense = np.zeros(size)             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     size = len(ObservedList) / 3
 *     for n in range(size):
 */
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_GetName</span>(__pyx_m, __pyx_n_s__np);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 149; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  __pyx_t_1 = <span class='py_c_api'>PyObject_GetAttr</span>(__pyx_t_2, __pyx_n_s__zeros);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 149; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 149; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 149; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_2);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_2);
  __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyObject_Call</span>(__pyx_t_1, ((PyObject *)__pyx_t_4), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 149; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
  if (!(likely(((__pyx_t_2) == Py_None) || likely(<span class='pyx_c_api'>__Pyx_TypeTest</span>(__pyx_t_2, __pyx_ptype_5numpy_ndarray)))))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 149; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  __pyx_t_5 = ((PyArrayObject *)__pyx_t_2);
  {
    __Pyx_BufFmt_StackElem __pyx_stack[1];
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Xdense);
    __pyx_t_3 = <span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_Xdense, (PyObject*)__pyx_t_5, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack);
    if (unlikely(__pyx_t_3 <code><</code> 0)) {
      <span class='py_c_api'>PyErr_Fetch</span>(&__pyx_t_6, &__pyx_t_7, &__pyx_t_8);
      if (unlikely(<span class='pyx_c_api'>__Pyx_GetBufferAndValidate</span>(&__pyx_bstruct_Xdense, (PyObject*)__pyx_v_Xdense, &__Pyx_TypeInfo_nn___pyx_t_5numpy_float_t, PyBUF_FORMAT| PyBUF_STRIDES, 1, 0, __pyx_stack) == -1)) {
        Py_XDECREF(__pyx_t_6); Py_XDECREF(__pyx_t_7); Py_XDECREF(__pyx_t_8);
        <span class='pyx_c_api'>__Pyx_RaiseBufferFallbackError</span>();
      } else {
        <span class='py_c_api'>PyErr_Restore</span>(__pyx_t_6, __pyx_t_7, __pyx_t_8);
      }
    }
    __pyx_bstride_0_Xdense = __pyx_bstruct_Xdense.strides[0];
    __pyx_bshape_0_Xdense = __pyx_bstruct_Xdense.shape[0];
    if (unlikely(__pyx_t_3 <code><</code> 0))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 149; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  }
  __pyx_t_5 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_v_Xdense));
  __pyx_v_Xdense = ((PyArrayObject *)__pyx_t_2);
  __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFF96' onclick='toggleDiv("line150")'> 150:     size = len(ObservedList) / 3</pre>
<pre id='line150' class='code' style='background-color: #FFFF96'>
  /* "CPWOPTcritical.pyx":150
 * 
 *     Xdense = np.zeros(size)
 *     size = len(ObservedList) / 3             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     for n in range(size):
 *         i = ObservedList[3*n]
 */
  __pyx_t_2 = ((PyObject *)__pyx_v_ObservedList);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2);
  __pyx_t_9 = <span class='py_c_api'>PyObject_Length</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(__pyx_t_9 == -1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 150; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  __pyx_v_size = __Pyx_div_Py_ssize_t(__pyx_t_9, 3);
</pre><pre class='line' style='background-color: #FFFF23' onclick='toggleDiv("line151")'> 151:     for n in range(size):</pre>
<pre id='line151' class='code' style='background-color: #FFFF23'>
  /* "CPWOPTcritical.pyx":151
 *     Xdense = np.zeros(size)
 *     size = len(ObservedList) / 3
 *     for n in range(size):             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         i = ObservedList[3*n]
 *         j = ObservedList[3*n+1]
 */
  __pyx_t_2 = <span class='py_c_api'>PyInt_FromLong</span>(__pyx_v_size);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 151; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  __pyx_t_4 = <span class='py_c_api'>PyTuple_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 151; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_4));
  <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_4, 0, __pyx_t_2);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_t_2);
  __pyx_t_2 = 0;
  __pyx_t_2 = <span class='py_c_api'>PyObject_Call</span>(__pyx_builtin_range, ((PyObject *)__pyx_t_4), NULL);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 151; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
  if (<span class='py_c_api'>PyList_CheckExact</span>(__pyx_t_2) || <span class='py_c_api'>PyTuple_CheckExact</span>(__pyx_t_2)) {
    __pyx_t_9 = 0; __pyx_t_4 = __pyx_t_2; <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_4);
  } else {
    __pyx_t_9 = -1; __pyx_t_4 = <span class='py_c_api'>PyObject_GetIter</span>(__pyx_t_2);<span class='error_goto'> if (unlikely(!__pyx_t_4)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 151; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_4);
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  for (;;) {
    if (likely(<span class='py_c_api'>PyList_CheckExact</span>(__pyx_t_4))) {
      if (__pyx_t_9 >= <span class='py_macro_api'>PyList_GET_SIZE</span>(__pyx_t_4)) break;
      __pyx_t_2 = <span class='py_macro_api'>PyList_GET_ITEM</span>(__pyx_t_4, __pyx_t_9); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2); __pyx_t_9++;
    } else if (likely(<span class='py_c_api'>PyTuple_CheckExact</span>(__pyx_t_4))) {
      if (__pyx_t_9 >= <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_t_4)) break;
      __pyx_t_2 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_t_4, __pyx_t_9); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_2); __pyx_t_9++;
    } else {
      __pyx_t_2 = <span class='py_c_api'>PyIter_Next</span>(__pyx_t_4);
      if (!__pyx_t_2) {
        if (unlikely(<span class='py_c_api'>PyErr_Occurred</span>()))<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 151; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
        break;
      }
      <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    }
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_n);
    __pyx_v_n = __pyx_t_2;
    __pyx_t_2 = 0;
</pre><pre class='line' style='background-color: #FFFF73' onclick='toggleDiv("line152")'> 152:         i = ObservedList[3*n]</pre>
<pre id='line152' class='code' style='background-color: #FFFF73'>
    /* "CPWOPTcritical.pyx":152
 *     size = len(ObservedList) / 3
 *     for n in range(size):
 *         i = ObservedList[3*n]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         j = ObservedList[3*n+1]
 *         k = ObservedList[3*n+2]
 */
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_int_3, __pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 152; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    __pyx_t_1 = <span class='py_c_api'>PyObject_GetItem</span>(((PyObject *)__pyx_v_ObservedList), __pyx_t_2);<span class='error_goto'> if (!__pyx_t_1) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 152; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_i);
    __pyx_v_i = __pyx_t_1;
    __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFF5b' onclick='toggleDiv("line153")'> 153:         j = ObservedList[3*n+1]</pre>
<pre id='line153' class='code' style='background-color: #FFFF5b'>
    /* "CPWOPTcritical.pyx":153
 *     for n in range(size):
 *         i = ObservedList[3*n]
 *         j = ObservedList[3*n+1]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         k = ObservedList[3*n+2]
 *         Xdense[n] = X[i,j,k]
 */
    __pyx_t_1 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_int_3, __pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 153; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_1, __pyx_int_1);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 153; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyObject_GetItem</span>(((PyObject *)__pyx_v_ObservedList), __pyx_t_2);<span class='error_goto'> if (!__pyx_t_1) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 153; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_j);
    __pyx_v_j = __pyx_t_1;
    __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFF5b' onclick='toggleDiv("line154")'> 154:         k = ObservedList[3*n+2]</pre>
<pre id='line154' class='code' style='background-color: #FFFF5b'>
    /* "CPWOPTcritical.pyx":154
 *         i = ObservedList[3*n]
 *         j = ObservedList[3*n+1]
 *         k = ObservedList[3*n+2]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *         Xdense[n] = X[i,j,k]
 *     return Xdense
 */
    __pyx_t_1 = <span class='py_c_api'>PyNumber_Multiply</span>(__pyx_int_3, __pyx_v_n);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 154; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    __pyx_t_2 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_1, __pyx_int_2);<span class='error_goto'> if (unlikely(!__pyx_t_2)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 154; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
    __pyx_t_1 = <span class='py_c_api'>PyObject_GetItem</span>(((PyObject *)__pyx_v_ObservedList), __pyx_t_2);<span class='error_goto'> if (!__pyx_t_1) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 154; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_1);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_k);
    __pyx_v_k = __pyx_t_1;
    __pyx_t_1 = 0;
</pre><pre class='line' style='background-color: #FFFF4b' onclick='toggleDiv("line155")'> 155:         Xdense[n] = X[i,j,k]</pre>
<pre id='line155' class='code' style='background-color: #FFFF4b'>
    /* "CPWOPTcritical.pyx":155
 *         j = ObservedList[3*n+1]
 *         k = ObservedList[3*n+2]
 *         Xdense[n] = X[i,j,k]             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 *     return Xdense
 * 
 */
    __pyx_t_1 = <span class='py_c_api'>PyTuple_New</span>(3);<span class='error_goto'> if (unlikely(!__pyx_t_1)) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 155; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(((PyObject *)__pyx_t_1));
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_i);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 0, __pyx_v_i);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_v_i);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_j);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 1, __pyx_v_j);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_v_j);
    <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_v_k);
    <span class='py_macro_api'>PyTuple_SET_ITEM</span>(__pyx_t_1, 2, __pyx_v_k);
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GIVEREF</span></span>(__pyx_v_k);
    __pyx_t_2 = <span class='py_c_api'>PyObject_GetItem</span>(((PyObject *)__pyx_v_X), ((PyObject *)__pyx_t_1));<span class='error_goto'> if (!__pyx_t_2) {__pyx_filename = __pyx_f[0]; __pyx_lineno = 155; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'><span class='refnanny'>__Pyx_GOTREF</span></span>(__pyx_t_2);
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(((PyObject *)__pyx_t_1)); __pyx_t_1 = 0;
    if (<span class='py_c_api'>PyObject_SetItem</span>(((PyObject *)__pyx_v_Xdense), __pyx_v_n, __pyx_t_2) <code><</code> 0)<span class='error_goto'> {__pyx_filename = __pyx_f[0]; __pyx_lineno = 155; __pyx_clineno = __LINE__; goto __pyx_L1_error;}</span>
    <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
  }
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_4); __pyx_t_4 = 0;
</pre><pre class='line' style='background-color: #FFFF3f' onclick='toggleDiv("line156")'> 156:     return Xdense</pre>
<pre id='line156' class='code' style='background-color: #FFFF3f'>
  /* "CPWOPTcritical.pyx":156
 *         k = ObservedList[3*n+2]
 *         Xdense[n] = X[i,j,k]
 *     return Xdense             # <code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code><code><</code>
 * 
 * 
 */
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(((PyObject *)__pyx_v_Xdense));
  __pyx_r = ((PyObject *)__pyx_v_Xdense);
  goto __pyx_L0;

  __pyx_r = Py_None; <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_None);
  goto __pyx_L0;
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_4);
  { PyObject *__pyx_type, *__pyx_value, *__pyx_tb;
    <span class='pyx_c_api'>__Pyx_ErrFetch</span>(&__pyx_type, &__pyx_value, &__pyx_tb);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_ObservedList);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_X);
    <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Xdense);
  <span class='pyx_c_api'>__Pyx_ErrRestore</span>(__pyx_type, __pyx_value, __pyx_tb);}
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("CPWOPTcritical.CompressSparseTensorToVector");
  __pyx_r = NULL;
  goto __pyx_L2;
  __pyx_L0:;
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_ObservedList);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_X);
  <span class='pyx_c_api'>__Pyx_SafeReleaseBuffer</span>(&__pyx_bstruct_Xdense);
  __pyx_L2:;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>((PyObject *)__pyx_v_Xdense);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_n);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_i);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_j);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_v_k);
  <span class='pyx_macro_api'><span class='refnanny'>__Pyx_XGIVEREF</span></span>(__pyx_r);
  <span class='pyx_c_api'><span class='refnanny'>__Pyx_RefNannyFinishContext</span></span>();
  return __pyx_r;
}
</pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line157")'> 157: </pre>
<pre id='line157' class='code' style='background-color: #FFFFff'></pre><pre class='line' style='background-color: #FFFFff' onclick='toggleDiv("line158")'> 158: </pre>
<pre id='line158' class='code' style='background-color: #FFFFff'></pre></body></html>
